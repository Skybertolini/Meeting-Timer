<!DOCTYPE html>
<html lang="no">
<head>
<link rel="icon" type="image/png" href="favicon.png">
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Study Timer</title>
<style>
:root{
  --green:#28a745; --blue:#0d6efd; --orange:#ff8800;
  --elapsed-fill:rgba(220,20,20,.35); --elapsed-line:#cc0000;
  --card-bg:rgba(255,255,255,.72); --card-border:rgba(0,0,0,.06);
  --muted:#9aa3ab; --radius:14px;
}
html,body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:linear-gradient(180deg,#f7f8fa 0%,#eef1f4 100%); margin:0; padding:24px;
  display:flex; flex-direction:column; align-items:center;
}
.container{ width:min(960px,94vw); max-width:880px }
.topbar{ width:100%; display:flex; justify-content:space-between; align-items:center; margin:-8px 0 12px }
.logo-box img{ max-height:120px; width:auto; border-radius:0; box-shadow:none }
.lang-select{
  appearance:none; border:1px solid rgba(0,0,0,.12); background:rgba(255,255,255,.85);
  border-radius:999px; padding:8px 14px; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,.06); cursor:pointer;
}

/* Inputs */
textarea{
  width:100%; height:180px; resize:vertical; padding:12px; font-size:1rem;
  border:1px solid rgba(0,0,0,.08); border-radius:var(--radius);
  background:var(--card-bg); box-shadow:0 8px 30px rgba(0,0,0,.08);
}
textarea:focus{ outline:none; border-color:rgba(46,170,220,.55); box-shadow:0 0 0 4px rgba(46,170,220,.18) }
textarea.collapsed{ height:64px!important; color:#7b8894!important; background:rgba(248,249,251,.85)!important }

.btn{
  background:var(--green); color:#fff; border:0; padding:12px 20px; border-radius:999px;
  cursor:pointer; font-size:1rem; margin:10px 10px 0 0; font-weight:600; box-shadow:0 8px 30px rgba(0,0,0,.08);
}
.btn:disabled{ background:#9aa3ab; cursor:not-allowed }
.btn.done{ padding:12px 16px }
.btn.done::before{ content:"✓"; font-weight:700 }

.info-line{ display:flex; flex-wrap:wrap; align-items:center; gap:14px; margin-top:10px }
.inline-edit{
  display:inline-flex; align-items:center; gap:8px; background:var(--card-bg);
  border:1px solid var(--card-border); border-radius:999px; padding:8px 10px; box-shadow:0 8px 30px rgba(0,0,0,.08);
}
.inline-edit label{ font-size:.95rem }
.inline-edit input{ width:90px; padding:6px 8px; font-size:1rem; border:1px solid #cfd4da; border-radius:8px; background:#fff }
.inline-edit input.ghost{ color:var(--muted)!important }

/* Title + message */
.title{ font-size:1.25rem; font-weight:700; margin-top:14px }
.container.running .title{ font-size:1.6rem; margin:18px 0 12px }
.message-box{
  margin-top:12px; padding:14px 18px; background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius); font-size:1.1rem; color:#0c2915; box-shadow:0 8px 30px rgba(0,0,0,.08); min-height:1.2em;
}

/* Timeline */
.timeline-wrap{ width:100%; margin-top:28px }
.timeline{
  position:relative; height:52px; border-radius:var(--radius);
  background:linear-gradient(180deg,#f3fbf6 0%,#eaf6ec 100%); border:1px solid rgba(0,0,0,.08);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.8), 0 8px 30px rgba(0,0,0,.08); overflow:visible;
}
.slot{ position:absolute; top:0; height:100%; opacity:.25 }
.para-slot{
  position:absolute; top:0; height:100%;
  display:flex; align-items:center; justify-content:center;
  border-left:1px solid rgba(0,0,0,.04); border-right:1px solid rgba(255,255,255,.45);
  pointer-events:auto; z-index:1; font-size:.82rem; font-weight:800; color:#134e2f; text-shadow:0 1px 0 rgba(255,255,255,.55);
  cursor:pointer;
}
.para-slot:hover{ filter:saturate(1.1) }
.elapsed{ position:absolute; top:0; left:0; height:100%; background:rgba(255,77,64,.25); width:0%; transition:width .25s linear; z-index:2 }
.cursor{ position:absolute; top:-10px; width:2px; height:72px; background:linear-gradient(#e3262e,#b4141a); left:0%; z-index:3; box-shadow:0 0 0 2px rgba(227,38,46,.12) }

#clock{ margin-top:24px; font-size:2.1rem; font-weight:800; color:#1e824c; text-shadow:0 1px 0 #fff }
#clock.over{ color:#c41111; text-shadow:none }

/* Controls */
.footer{ margin-top:22px; width:100%; display:flex; gap:14px }
.round-btn{ display:inline-flex; align-items:center; justify-content:center; width:56px; height:56px; border-radius:999px; border:0; cursor:pointer; box-shadow:0 8px 30px rgba(0,0,0,.08) }
.play-btn{ background:var(--green) } .play-btn::before{ content:"▶"; color:#fff; font-size:1.5rem; margin-left:3px }
.pause-btn{ background:#f0ad4e } .pause-btn::before{ content:"❚❚"; color:#fff; font-size:1.2rem }
/* Stop vs Rewind (toggler dynamisk i JS) */
.stop-btn{ background:#d21f3c } .stop-btn::before{ content:""; display:block; width:16px; height:16px; background:#fff; border-radius:2px }
.rewind-btn{ background:#6c757d } .rewind-btn::before{ content:"↺"; color:#fff; font-size:1.4rem }

.play-btn:disabled,.pause-btn:disabled,.stop-btn:disabled,.rewind-btn:disabled{ background:#aaa; cursor:not-allowed; box-shadow:none }

/* Notes + footer */
.notes-section{ margin-top:32px }
.notes-section label{ font-weight:600; display:block; margin-bottom:6px }
.notes-section textarea{ height:120px }
.copyright{ margin-top:24px; font-size:.9rem; color:#777; text-align:center }

/* Mild Dark Mode */
@media (prefers-color-scheme: dark){
  :root{ --card-bg:#3a3a3a; --card-border:rgba(255,255,255,.08) }
  body{ background:linear-gradient(180deg,#2b2b2b 0%,#2f3032 100%); color:#f2f2f2 }
  .lang-select{ border-color:rgba(255,255,255,.15); background:#3a3a3a; color:#f2f2f2; box-shadow:none }
  textarea, .inline-edit, .message-box, .notes-section textarea{
    background:#3a3a3a; color:#f2f2f2; border-color:rgba(255,255,255,.12); box-shadow:none;
  }
  textarea:focus{ box-shadow:0 0 0 4px rgba(80,170,220,.18) }
  .timeline{ background:linear-gradient(180deg,#3a403c 0%,#333b36 100%); border-color:rgba(255,255,255,.12); box-shadow:none }
  .para-slot{
    color:#111 !important;      /* mørke tall i dark mode for god kontrast */
    text-shadow:none;
    border-left-color:rgba(255,255,255,.06);
    border-right-color:rgba(255,255,255,.06);
  }
  #clock{ color:#9af0ba; text-shadow:none }
  .copyright{ color:#c7c7c7 }
}
</style>
</head>
<body>
<div class="container" id="appContainer">
  <div class="topbar">
    <div class="logo-box">
      <picture>
        <source srcset="study-timer-logo-dark-mode.png" media="(prefers-color-scheme: dark)">
        <img src="study-timer-logo.png" alt="Study Timer logo">
      </picture>
    </div>
    <select id="langSelect" class="lang-select" aria-label="Language">
      <option value="no">Norwegian</option><option value="sv">Swedish</option>
      <option value="da">Danish</option><option value="en">English</option><option value="es">Spanish</option>
    </select>
  </div>

  <textarea id="articleText" data-i18n-placeholder="placeholder_article" placeholder=""></textarea>
  <button id="analyzeBtn" class="btn" data-i18n="analyze">Analyser</button>

  <div class="info-line" id="infoLine">
    <div class="inline-edit"><label for="editParagraphs" data-i18n="paragraphs">Avsnitt</label><input id="editParagraphs" type="number" min="1" value="0" class="ghost"></div>
    <div class="inline-edit"><label for="editQuestions" data-i18n="questions">Spørsmål</label><input id="editQuestions" type="number" min="0" value="0" class="ghost"></div>
    <div class="inline-edit"><label for="editScriptures" data-i18n="scriptures">Les-skriftsteder</label><input id="editScriptures" type="number" min="0" value="0" class="ghost"></div>
    <button id="adjustBtn" class="btn" data-i18n="adjust" disabled>Juster</button>
  </div>

  <div id="articleTitle" class="title" data-i18n="title_default"></div>
  <div id="message" class="message-box" data-i18n="msg_init">Begynn med å lime inn artikkelserien og analysere den.</div>

  <div class="timeline-wrap">
    <div id="timeline" class="timeline">
      <div id="introSlot"  class="slot" style="background:var(--blue)"></div>
      <div id="reviewSlot" class="slot" style="background:var(--orange)"></div>
      <div id="outroSlot"  class="slot" style="background:var(--blue)"></div>
      <div id="elapsed" class="elapsed"></div>
      <div id="cursor"  class="cursor"></div>
    </div>
    <div id="clock" class="clock">00:00</div>
  </div>

  <div class="footer">
    <button id="playBtn"  class="round-btn play-btn"  disabled data-i18n-title="tooltip_play"  title="Start/Gjenoppta"></button>
    <button id="pauseBtn" class="round-btn pause-btn" disabled data-i18n-title="tooltip_pause" title="Pause"></button>
    <!-- Denne knappen bytter klasse/ikon i JS mellom stop-btn (■) og rewind-btn (↺) -->
    <button id="stopBtn"  class="round-btn stop-btn"  disabled title="Ferdig"></button>
  </div>

  <div class="notes-section">
    <label for="notes" data-i18n="notes">Notater</label>
    <textarea id="notes" data-i18n-placeholder="placeholder_notes" placeholder=""></textarea>
  </div>

  <div class="copyright">Study Timer © 2025 · Version 1.18</div>
</div>

<!-- i18n -->
<script src="i18n/i18n.js"></script>

<script>
/* ====== Konstanter ====== */
const TOTAL_SEC=3600, INTRO_SEC=90, REVIEW_SEC=120, OUTRO_SEC=90, CONTENT_SEC=TOTAL_SEC-INTRO_SEC-REVIEW_SEC-OUTRO_SEC;
const WPM=150, SEC_PER_Q=10, SEC_PER_LES=30, AB_BONUS=30;
const HEADER_RE=/^(\d+(?:[\s\u00A0]*,[\s\u00A0]*\d+)*)\.\s*(.*)?$/;
const BODY_START_RE=/^(\d+)[\.\s\u00A0]+(.*)$/;
const $=id=>document.getElementById(id), pct=sec=>sec/TOTAL_SEC*100;

/* ====== Tilstand ====== */
let paras=[], totalParagraphs=0, questions=0, scriptures=0, perParagraph=[], cumulative=[];
let started=false, paused=false, startTs=null, accumSec=0, tickHandle=null, lastMilestone="";
let stopIsRewind=false; // NY: sporing av stop/rewind-modus

/* ====== Lyttere ====== */
$('analyzeBtn').addEventListener('click',onAnalyze);
$('playBtn').addEventListener('click',onPlay);
$('pauseBtn').addEventListener('click',onPause);
$('stopBtn').addEventListener('click',onStopOrRewind);
['editParagraphs','editQuestions','editScriptures'].forEach(id=>{
  $(id).addEventListener('input',e=>e.target.classList.remove('ghost'));
  $(id).addEventListener('change',e=>e.target.classList.remove('ghost'));
});
$('adjustBtn').addEventListener('click',onAdjust);

/* ====== Utils ====== */
function fmt(s){
  const sec = Math.max(0, Math.floor(s)); // alltid mm:ss
  const m = Math.floor(sec/60), r = sec%60;
  return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0');
}
function setMessage(m){ if(m!==lastMilestone){ $('message').textContent=m; lastMilestone=m; } }
function i18nT(k){ return (window.i18n && i18n.t) ? i18n.t(k) : k; }

/* ====== Stop/Rewind toggling ====== */
function setStopAsRewind(isRewind){
  const btn=$('stopBtn');
  stopIsRewind = !!isRewind;
  btn.classList.toggle('stop-btn', !stopIsRewind);
  btn.classList.toggle('rewind-btn', stopIsRewind);
  if(stopIsRewind){
    btn.title = 'Nullstill'; // (kan i18n-iseres ved behov)
    btn.disabled = false;    // gjør den aktiv etter stopp
  }else{
    btn.title = i18nT('tooltip_stop') || 'Ferdig';
    // aktiv under kjøring, ellers styrer onPlay/onPause
  }
}

/* ====== Analyse ====== */
function onAnalyze(){
  const raw=$('articleText').value.trim(); if(!raw){ alert(i18nT('err_paste_first')); return; }
  analyzeText(raw);

  const ta=$('articleText');
  ta.classList.add('collapsed'); ta.style.height='64px'; ta.style.color='#7b8894';
  ta.style.background='rgba(248,249,251,.85)'; ta.blur();

  const ab=$('analyzeBtn'); ab.textContent=''; ab.classList.add('done'); ab.disabled=true;

  if(totalParagraphs>0){
    setMessage(i18nT('msg_ready'));
    $('playBtn').disabled=false; $('pauseBtn').disabled=true;
    $('stopBtn').disabled=true; setStopAsRewind(false);
  }else{
    setMessage(i18nT('msg_none'));
    $('playBtn').disabled=true; $('pauseBtn').disabled=true;
    $('stopBtn').disabled=true; setStopAsRewind(false);
  }
}
function analyzeText(text){
  const norm=text.replace(/\u00A0/g,' ');
  const lines=norm.split('\n').map(l=>l.trim()).filter(Boolean);

  const title=pickTitle(lines) || i18nT('title_default');
  $('articleTitle').textContent=title;

  paras=extractParagraphs(lines); totalParagraphs=paras.length;
  questions=paras.reduce((s,p)=>s+p.q,0); scriptures=paras.reduce((s,p)=>s+p.les,0);

  computeAllocation(); drawTimeline(); updateInfoLine(true); resetClockUI();
}
function pickTitle(lines){
  const blacklist=/^(Publikasjoner|STUDIEARTIKKEL\b|SANG\b|FOKUS\b|Underoverskrifter|Lignende stoff|Audio Player|Norsk\b|Del\b|Innstillinger\b|Logg inn\b|JW\.ORG\b|HVA SVARER DU\b|w\d{2}\b)/i;
  const looksLikeTheme=/^\s*(«.+»|".+")\s*—\s*[1-3]?\s*[A-ZÆØÅ][a-zæøå. ]*\d/;
  const tooMany=l=>l.split(/\s+/).length>16;

  const idxSang=lines.findIndex(l=>/^SANG[\s\u00A0]*\d+/i.test(l));
  if(idxSang>=0){
    for(let j=idxSang+1;j<Math.min(lines.length,idxSang+8);j++){
      const c=(lines[j]||'').trim(); if(!c)continue;
      if(blacklist.test(c))continue; if(/^\d/.test(c))continue;
      if(!/[A-Za-zÆØÅæøå]/.test(c))continue; if(!/[a-zæøå]/.test(c))continue;
      if(looksLikeTheme.test(c))continue; if(tooMany(c))continue;
      if(c.length<6||c.length>160)continue;
      return c;
    }
  }
  const firstParaIdx=lines.findIndex(l=>HEADER_RE.test(l)||BODY_START_RE.test(l));
  const headerZone=firstParaIdx>-1?lines.slice(0,firstParaIdx):lines.slice(0,30);
  const cands=headerZone.filter(l=>{
    if(blacklist.test(l))return false; if(/^\d/.test(l))return false;
    if(!/[A-Za-zÆØÅæøå]/.test(l))return false; if(!/[a-zæøå]/.test(l))return false;
    if(looksLikeTheme.test(l))return false; if(tooMany(l))return false;
    if(l.length<6||l.length>160)return false; return true;
  });
  if(!cands.length)return '';
  const score=s=>(/[–—-]/.test(s)?3:0)+(/:/.test(s)?1:0)+Math.max(0,16-s.split(/\s+/).length);
  cands.sort((a,b)=>score(b)-score(a)); return cands[0];
}
function extractParagraphs(lines){
  const out=[]; let pendingNums=[],pendingAB=false,currentNum=null,currentAB=false,buf=[];
  const skip=/^(HVA SVARER DU|Svaret ditt)$/i;
  const push=()=>{
    if(currentNum!==null){
      const text=buf.join(' ').trim();
      const words=(text.match(/\S+/g)||[]).length;
      const q=1; // 1 spørsmål per nummerert avsnitt
      const les=(text.match(/\bLes\b/gi)||[]).length; // Les hvor som helst i avsnitt
      out.push({num:currentNum,text,words,q,les,hasAB:currentAB});
    }
    buf=[];
  };
  for(const raw of lines){
    const l=raw.trim(); if(!l||skip.test(l)) continue;
    const h=l.match(HEADER_RE);
    if(h){
      push();
      pendingNums=h[1].split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n));
      const head=(h[2]||''); const hasA=/\(a\)/i.test(head), hasB=/\(b\)/i.test(head);
      pendingAB=(hasA&&hasB);
      if(pendingNums.length){ currentNum=pendingNums.shift(); currentAB=pendingAB; } else { currentNum=null; currentAB=false; }
      if(head) buf.push(head);
      continue;
    }
    const b=l.match(BODY_START_RE);
    if(b){
      const n=parseInt(b[1],10); const rest=(b[2]||'').trim();
      if(pendingNums.length && n===pendingNums[0]){
        push(); currentNum=pendingNums.shift(); currentAB=pendingAB; if(rest) buf.push(rest); continue;
      }
      if(currentNum===null || n!==currentNum){
        push(); currentNum=n; currentAB=false; if(rest) buf.push(rest); continue;
      }
      if(rest) buf.push(rest); continue;
    }
    buf.push(l);
  }
  push();

  const seen=new Set(), clean=[];
  for(const p of out.sort((a,b)=>a.num-b.num)){
    if(!seen.has(p.num)){ clean.push(p); seen.add(p.num); }
    else{
      const last=cleaned[cleaned.length-1];
    }
  }

  // NB: quick fix for duplikat-merging (korrigert)
  clean.length=0; // reset og bygg på nytt korrekt
  const grouped=new Map();
  for(const p of out){
    if(!grouped.has(p.num)) grouped.set(p.num,{...p});
    else{
      const g=grouped.get(p.num);
      g.text += ' ' + p.text;
      g.words = (g.text.match(/\S+/g)||[]).length;
      g.les += p.les;
      g.hasAB = g.hasAB || p.hasAB;
    }
  }
  [...grouped.keys()].sort((a,b)=>a-b).forEach(k=>clean.push(grouped.get(k)));

  if(!clean.length){
    const joined=lines.join('\n');
    const rough=joined.split(/\n(?=\d+[.]\s)/).filter(s=>/^\d+[.]\s/.test(s));
    rough.forEach((block,i)=>{
      const text=block.replace(/^\d+[.]\s*/,''); const words=(text.match(/\S+/g)||[]).length;
      const q=1; const les=(text.match(/\bLes\b/gi)||[]).length;
      clean.push({num:i+1,text,words,q,les,hasAB:false});
    });
  }
  return clean;
}

/* ====== Fordeling & tidslinje ====== */
function computeAllocation(){
  if(totalParagraphs===0){ perParagraph=[]; cumulative=[]; return; }
  let list=paras.slice(0,totalParagraphs);
  while(list.length<totalParagraphs) list.push({num:list.length+1,text:'',words:0,q:1,les:0,hasAB:false});
  const wps=WPM/60;
  const raw=list.map(p=>{
    let sec=(p.words||0)/wps + (p.q||0)*SEC_PER_Q + (p.les||0)*SEC_PER_LES;
    if(p.hasAB) sec+=AB_BONUS;
    return Math.max(5,sec);
  });
  const scale=CONTENT_SEC/(raw.reduce((a,b)=>a+b,0)||1);
  perParagraph=raw.map(x=>x*scale);
  cumulative=[]; let acc=INTRO_SEC;
  for(let i=0;i<totalParagraphs;i++){ cumulative.push(acc); acc+=perParagraph[i]; }
}
function hexToRgb(h){const s=h.replace('#','');const n=s.length===3?s.split('').map(x=>x+x).join(''):s;return{r:parseInt(n.slice(0,2),16),g:parseInt(n.slice(2,4),16),b:parseInt(n.slice(4,6),16)}}
function lerpColor(h1,h2,t){const a=hexToRgb(h1),b=hexToRgb(h2);const r=Math.round(a.r+(b.r-a.r)*t),g=Math.round(a.g+(b.g-a.g)*t),bl=Math.round(a.b+(b.b-a.b)*t);return`rgb(${r}, ${g}, ${bl})`}
function drawTimeline(){
  const t=$('timeline'); Array.from(t.querySelectorAll('.para-slot')).forEach(n=>n.remove());
  $('introSlot').style.left='0%'; $('introSlot').style.width=pct(INTRO_SEC).toFixed(5)+'%';
  $('outroSlot').style.right='0%'; $('outroSlot').style.width=pct(OUTRO_SEC).toFixed(5)+'%';
  $('reviewSlot').style.right=pct(OUTRO_SEC).toFixed(5)+'%'; $('reviewSlot').style.width=pct(REVIEW_SEC).toFixed(5)+'%';
  if(totalParagraphs<=0){$('elapsed').style.width='0%';$('cursor').style.left='0%';return;}
  const startCol='#e8f6ee', endCol='#bfe3ce', elapsedNode=$('elapsed');
  for(let i=1;i<=totalParagraphs;i++){
    const leftP=pct(cumulative[i-1]), widthP=pct(perParagraph[i-1]);
    const slot=document.createElement('div');
    slot.className='para-slot'; slot.style.left=leftP+'%'; slot.style.width=widthP+'%';
    slot.dataset.idx=String(i-1);
    const tN=(i-1)/Math.max(1,(totalParagraphs-1));
    slot.style.background=lerpColor(startCol,endCol,tN);
    const lbl=document.createElement('div'); lbl.textContent=String(i); slot.appendChild(lbl);

    // Klikk for å hoppe etter Stopp
    slot.addEventListener('click',()=>{
      if(started) return;
      const idx=parseInt(slot.dataset.idx,10); if(isNaN(idx)) return;
      const target=cumulative[idx];
      accumSec = Math.min(Math.round(target), TOTAL_SEC - OUTRO_SEC - REVIEW_SEC); // heltall mm:ss
      const pNow=Math.min(accumSec/TOTAL_SEC*100,100);
      $('elapsed').style.width=pNow+'%';
      $('cursor').style.left=`calc(${pNow}% - 1px)`;
      $('clock').textContent = fmt(accumSec);
      $('clock').classList.toggle('over', accumSec>=TOTAL_SEC);
      setMessage(i18nT('msg_section_prefix') + (idx+1));
    });

    t.insertBefore(slot, elapsedNode);
  }
  $('elapsed').style.width='0%'; $('cursor').style.left='0%';
}

/* ====== Klokke / meldinger ====== */
function resetClockUI(){ if(tickHandle)clearInterval(tickHandle); $('clock').textContent='00:00'; $('clock').classList.remove('over'); }
function startClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=setInterval(tick,250); }
function stopClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=null; }
function currentElapsed(){ if(!started) return accumSec; if(paused) return accumSec; const live=Math.floor((Date.now()-startTs)/1000); return accumSec+live; }
function tick(){
  const elapsed=currentElapsed();
  $('clock').textContent=fmt(elapsed);
  $('clock').classList.toggle('over', elapsed>=TOTAL_SEC);
  const p=Math.min(elapsed/TOTAL_SEC*100,100);
  $('elapsed').style.width=p+'%'; $('cursor').style.left=`calc(${p}% - 1px)`;
  if(elapsed<INTRO_SEC){ setMessage(i18nT('msg_intro')); }
  else if(elapsed>=TOTAL_SEC){ setMessage(i18nT('msg_overtime')); }
  else if(elapsed>=TOTAL_SEC-OUTRO_SEC){ setMessage(i18nT('msg_outro')); }
  else if(elapsed>=TOTAL_SEC-OUTRO_SEC-REVIEW_SEC){ setMessage(i18nT('msg_review')); }
  else{
    let idx=0;
    for(let i=0;i<totalParagraphs;i++){
      const start=cumulative[i], end=(i===totalParagraphs-1)?(TOTAL_SEC-OUTRO_SEC-REVIEW_SEC):cumulative[i+1];
      if(elapsed>=start && elapsed<end){ idx=i; break; }
    }
    let msg=i18nT('msg_section_prefix') + (idx+1);
    if(elapsed>=1800 && elapsed<1860) msg+=i18nT('msg_half');
    setMessage(msg);
  }
}

/* ====== Controls ====== */
function onPlay(){
  if(stopIsRewind){
    // hvis vi er i rewind-modus og brukeren trykker play: start fra accumSec (kan være 0 etter reset)
    setStopAsRewind(false);
  }

  if(started && paused){
    paused=false; startTs=Date.now(); startClock();
    $('playBtn').disabled=true; $('pauseBtn').disabled=false; $('stopBtn').disabled=false;
    return;
  }
  if(!started){
    startTs=Date.now(); started=true; paused=false;
    const info=$('infoLine'); if(info) info.style.display='none';
    $('appContainer').classList.add('running');
    setMessage(i18nT('msg_intro'));
    startClock();
    $('playBtn').disabled=true; $('pauseBtn').disabled=false; $('stopBtn').disabled=false;
  }
}
function onPause(){
  if(!started || paused) return;
  accumSec += Math.floor((Date.now()-startTs)/1000);
  paused=true; stopClock(); setMessage(i18nT('msg_pause'));
  $('playBtn').disabled=false; $('pauseBtn').disabled=true; $('stopBtn').disabled=false;
}
function onStopOrRewind(){
  if(stopIsRewind){
    // Reset (↺)
    accumSec = 0;
    resetClockUI();
    $('elapsed').style.width='0%'; $('cursor').style.left='0%';
    setMessage(i18nT('msg_ready'));
    // etter reset: info-linjen synlig, klar for ny start
    const info=$('infoLine'); if(info) info.style.display='flex';
    $('appContainer').classList.remove('running');
    $('playBtn').disabled=false; $('pauseBtn').disabled=true; $('stopBtn').disabled=true;
    setStopAsRewind(false); // gjør den til "stop" igjen til neste kjøring
    return;
  }

  // Stopp (■)
  if(started && !paused){ accumSec += Math.floor((Date.now()-startTs)/1000); }
  stopClock();
  setMessage(i18nT('msg_finished_prefix') + fmt(accumSec));
  started=false; paused=false;

  $('playBtn').disabled=false; $('pauseBtn').disabled=true; $('stopBtn').disabled=false;
  const info=$('infoLine'); if(info) info.style.display='flex';
  $('appContainer').classList.remove('running');
  setStopAsRewind(true); // bytt til rewind-modus etter stopp
}

/* ====== Justerfelt ====== */
function onAdjust(){
  const pVal=parseInt($('editParagraphs').value,10);
  const qVal=parseInt($('editQuestions').value,10);
  const sVal=parseInt($('editScriptures').value,10);
  if(!isNaN(pVal)&&pVal>0&&pVal!==totalParagraphs){
    totalParagraphs=pVal;
    if(paras.length>totalParagraphs) paras=paras.slice(0,totalParagraphs);
    else while(paras.length<totalParagraphs) paras.push({num:paras.length+1,text:'',words:0,q:1,les:0,hasAB:false});
    computeAllocation(); drawTimeline();
  }
  if(!isNaN(qVal)&&qVal>=0) questions=qVal;
  if(!isNaN(sVal)&&sVal>=0) scriptures=sVal;
  updateInfoLine(false);
}
function updateInfoLine(resetGhost){
  $('editParagraphs').value=Math.max(1,totalParagraphs|0);
  $('editQuestions').value=Math.max(0,questions|0);
  $('editScriptures').value=Math.max(0,scriptures|0);
  if(resetGhost){
    $('editParagraphs').classList.add('ghost');
    $('editQuestions').classList.add('ghost');
    $('editScriptures').classList.add('ghost');
  }
  $('adjustBtn').disabled=!(totalParagraphs>0);
}
</script>

<!-- Cloudflare Web Analytics -->
<script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"9e80768d4f6c41f69cb40367aebcc56b"}'></script>
<!-- End Cloudflare Web Analytics -->
</body>
</html>
