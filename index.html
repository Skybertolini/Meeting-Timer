<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Meeting Timer</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f8f7f5">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Nunito 600‚Äì900 -->
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-top:#f8f7f5; --bg-bot:#f3f2ef; --ink:#2b3432; --muted:#8b827a;
  --card:rgba(255,255,252,.98); --border:rgba(40,30,20,.10);
  --green:#2f5f49; --orange:#c7843a; --red:#b54a46; --pill:#fffefb;
  --radius:16px;

  /* Papir-gr√∏nn tidslinje + faser */
  --tl-green-1:#e9f3ec;
  --tl-green-2:#deefe4;
  --phase-intro:#f2e2cf;    /* mild oransje */
  --phase-review:#f3edc8;   /* lys gul */
  --phase-outro:#f2e2cf;
}

/* Base */
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{
  margin:0; color:var(--ink);
  background:linear-gradient(180deg,var(--bg-top) 0%,var(--bg-bot) 100%);
  font-family:"Nunito", ui-rounded, -apple-system, BlinkMacSystemFont, "SF Pro Text","SF Pro Display", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  letter-spacing:.01em; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  height:100%;
}
body{display:flex; flex-direction:column; min-height:100%}
.container{
  flex:1 0 auto; max-width:980px; margin:0 auto; padding:16px 16px 28px;
  min-width:320px; /* üîí stabil bredde s√• topplinje ikke hopper */
}
.footer{flex:0 0 auto; text-align:center; color:var(--muted); font-size:.9rem; padding:10px 0 14px}

body::before{
  content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
  background:
    radial-gradient( circle at 10% 20%, rgba(0,0,0,.015) 0 2px, transparent 3px ),
    radial-gradient( circle at 80% 40%, rgba(0,0,0,.012) 0 2px, transparent 3px ),
    radial-gradient( circle at 40% 70%, rgba(0,0,0,.010) 0 2px, transparent 3px );
  mix-blend-mode:multiply;
}

/* Topbar */
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0 18px;
  min-height:72px; /* üîí l√•s h√∏yde s√• knappene ikke flytter seg */
}
.brand{display:flex; align-items:center; gap:12px; position:relative}
.brand img{height:160px; width:auto; cursor:pointer; filter:drop-shadow(0 8px 24px rgba(70,50,30,.08)); transition:transform .25s,filter .25s}
@media (min-width:768px){ .brand img{height:200px} }

/* Lys-eksplosjon + shake */
.brand .burst { position:absolute; inset:0; pointer-events:none; overflow:visible; }
.brand .burst::before,
.brand .burst::after {
  content:""; position:absolute; left:50%; top:50%;
  width:0; height:0; border-radius:999px; opacity:0;
  background:radial-gradient(circle, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 60%);
}
.brand.explode .burst::before { animation:burstRing .9s ease-out forwards; }
.brand.explode .burst::after  { animation:burstRing 1.2s .08s ease-out forwards; }
@keyframes burstRing {
  0% { width:0; height:0; opacity:.35; transform:translate(-50%,-50%) scale(.9); }
  70%{ opacity:.18; }
  100%{ width:520px; height:520px; opacity:0; transform:translate(-50%,-50%) scale(1.15); }
}
.brand img.shake { animation:logoShake .48s ease-in-out; }
@keyframes logoShake {
  0%{ transform:translate3d(0,0,0) rotate(0deg) scale(1.01); }
  20%{ transform:translate3d(-1px,0,0) rotate(-.6deg) }
  40%{ transform:translate3d(1px,0,0) rotate(.6deg) }
  60%{ transform:translate3d(-1px,0,0) rotate(-.4deg) }
  80%{ transform:translate3d(1px,0,0) rotate(.3deg) }
  100%{ transform:translate3d(0,0,0) rotate(0) scale(1) }
}

/* Segmented ‚Äì IKONER KUN */
.segmented{display:inline-flex; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:6px; gap:6px; box-shadow:0 8px 24px rgba(70,50,30,.06); flex-shrink:0;}
.segmented button{border:0; background:transparent; padding:12px; border-radius:999px; cursor:pointer; display:flex; align-items:center; justify-content:center}
.segmented button img{width:33px; height:33px; display:block}
.segmented button.active{
  background:#efece6;
  box-shadow: inset 0 3px 10px rgba(50,40,30,.15), 0 2px 8px rgba(70,50,30,.05);
  transform: translateY(1px);
}

/* Kort/pill/select */
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 12px 40px rgba(70,50,30,.06); padding:14px}
.infoband{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.pill{background:var(--pill); border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-weight:600; box-shadow:0 4px 14px rgba(70,50,30,.05); color:#4a5552}
.select{appearance:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:var(--pill); font-weight:900; color:var(--ink); box-shadow:0 4px 14px rgba(70,50,30,.05); min-width:220px}

/* Tekst/meldinger */
.h1{font-size:1.38rem; font-weight:900; margin:18px 0 10px; text-transform:uppercase}
.message{background:var(--pill); border:1px solid var(--border); border-radius:12px; padding:12px 14px; min-height:1.2em; box-shadow:0 8px 24px rgba(70,50,30,.05); margin-bottom:12px; color:#4a5552}

/* Tidslinje ‚Äì gr√∏nn papirlook */
.timeline-wrap{margin-top:22px}
.timeline{position:relative; height:56px; border-radius:14px; overflow:visible; background:linear-gradient(180deg, var(--tl-green-1) 0%, #edf5f0 100%); border:1px solid var(--border); box-shadow:inset 0 1px 0 rgba(255,255,255,.7),0 12px 36px rgba(70,50,30,.05)}
.slot{position:absolute; top:0; height:100%; opacity:.22}
#introSlot{background:var(--phase-intro)}
#reviewSlot{background:var(--phase-review)}
#outroSlot{background:var(--phase-outro)}
.para-slot{position:absolute; top:0; height:100%; display:flex; align-items:center; justify-content:center; border-left:1px solid rgba(50,35,25,.06); border-right:1px solid rgba(255,255,255,.55); font-weight:900; color:#2f3b34; text-shadow:0 1px 0 rgba(255,255,255,.55); cursor:pointer; box-sizing:border-box; min-width:14px; background:var(--tl-green-1)}
.para-slot.alt{background:var(--tl-green-2)}
.para-slot>div{pointer-events:none; white-space:nowrap; overflow:hidden; line-height:1}
.elapsed{position:absolute; top:0; left:0; height:100%; background:rgba(58,111,82,.22); width:0%; transition:width .25s linear; z-index:2}
.cursor{position:absolute; top:-10px; width:2px; height:76px; background:#2f5f49; left:0%; z-index:3; box-shadow:0 0 0 2px rgba(58,111,82,.10)}
.big-clock,.clock{margin-top:16px; font-size:2.2rem; font-weight:900; color:#2f5f49; text-shadow:0 1px 0 rgba(255,255,255,.65)}
#clockWT{font-size:2.75rem}
.over{color:#b54a46 !important; text-shadow:none}

/* Kontroller */
.controls{display:flex; gap:12px; margin-top:12px}
.round{width:58px; height:58px; border-radius:999px; border:0; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.5rem; box-shadow:0 10px 24px rgba(70,50,30,.08)}
.play{background:var(--green)} .pause{background:var(--orange)} .stop{background:var(--red)} .round:disabled{background:#bfb8af; cursor:not-allowed; box-shadow:none}

/* Views */
.view{display:none} .view.active{display:block}

/* TALER */
.center{text-align:center}
/* Presets */
.preset-row{display:flex; gap:12px; justify-content:center; flex-wrap:wrap}
.preset{border:1px solid var(--border); background:var(--pill); border-radius:999px; padding:15px 21px; font-weight:900; cursor:pointer; box-shadow:0 8px 20px rgba(70,50,30,.06); color:var(--green); font-size:1.25rem}
.preset.active{background:#2f5f49; color:#fff}

/* Slider-dial (minutter) */
.picker{margin-top:12px; display:flex; gap:14px; justify-content:center; align-items:center}
.dial{position:relative; width:min(520px,80vw); height:72px}
.dial .track{
  position:absolute; left:0; right:0; bottom:8px; height:10px;
  background:linear-gradient(180deg,#d7d6d4 0%, #cac8c5 100%);
  border-radius:999px; box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
}
.dial .thumb{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:46px; height:46px; border-radius:999px; background:#7f807f;
  box-shadow:0 8px 18px rgba(0,0,0,.18), inset 0 2px 4px rgba(255,255,255,.2);
  transition:transform .06s ease;
}
.dial .thumb:active{ transform:translate(-50%,-50%) scale(0.98) }
.ticks{position:absolute; left:0; right:0; top:0; height:48px; display:flex; justify-content:space-between; pointer-events:none}
.ticks span{
  font-weight:900; font-size:32px; color:#222; opacity:.16; transition:opacity .1s;
}
.ticks span.active{ opacity:1; }
.ticks span.near { opacity:.5; }

/* Milestone-bilde */
.milestone-img{max-width:40%; height:auto; margin:12px auto; display:block; background:none; padding:0; border:none; box-shadow:none; opacity:0; transform:translateY(4px); transition:opacity .25s,transform .25s}
.milestone-img.show{opacity:1; transform:translateY(0)}

/* Smalt */
@media (max-width:420px){
  .brand img{height:150px}
  .timeline{height:52px}
  .cursor{height:72px}
}

/* Skjul-kort mens det spilles */
.hiddenCard{opacity:0; transform:translateY(-6px); height:0; margin:0; padding-top:0; padding-bottom:0; overflow:hidden}
.hiddenSoft{opacity:0; height:0; margin:0; padding-top:0; padding-bottom:0; overflow:hidden; transform:translateY(-4px); transition:opacity .2s,transform .2s,height .2s,margin .2s}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand" id="brandBox">
      <div class="burst"></div>
      <img id="logoImg" src="meeting-timer-logo.png" alt="Meeting Timer logo">
    </div>

    <div class="segmented" role="tablist" aria-label="Modus">
      <button id="tabSP" class="active" role="tab" aria-selected="true" title="Taler">
        <img id="otherIcon" src="other-icon.png" alt="">
      </button>
      <button id="tabWT" role="tab" aria-selected="false" title="Vaktt√•rn">
        <img src="watchtower-icon.png" alt="">
      </button>
    </div>
  </div>

  <!-- TALER (standard aktiv) -->
  <div id="viewSP" class="view active">
    <div class="card" id="spCard">
      <!-- Liten tittel som matcher beskjedstilen, men i bold -->
      <div style="font-weight:1000; color:#4a5552; margin:2px 0 8px;">
        TIMER FOR MIDTUKEM√òTET
      </div>

      <div id="spInputs" style="margin-bottom:6px">
        <div class="preset-row">
          <button class="preset" data-sec="0">0</button>
          <button class="preset" data-sec="300">5</button>
          <button class="preset" data-sec="600">10</button>
          <button class="preset" data-sec="900">15</button>
          <button class="preset" data-sec="1800">30</button>
        </div>

        <div class="picker" id="minuteSlider">
          <button id="minDec" aria-label="Mindre tid">‚Äπ</button>
          <div class="dial">
            <div class="ticks" id="ticks"></div>
            <div class="track"><div class="thumb" id="thumb"></div></div>
          </div>
          <button id="minInc" aria-label="Mer tid">‚Ä∫</button>
        </div>
      </div>

      <!-- TALER tidslinje (prosent/30 min skala ved count-up, ellers valgt lengde) -->
      <div class="timeline-wrap">
        <div id="timelineSP" class="timeline">
          <div id="elapsedSP" class="elapsed"></div>
          <div id="cursorSP"  class="cursor"></div>
        </div>
      </div>

      <div class="big-clock" id="clockSP" style="margin-top:12px">00:00</div>

      <img id="msImg" class="milestone-img" alt="" style="display:none"/>

      <div class="message" id="msgSP">Start stoppeklokken eller velg en tid og start nedtelling.</div>

      <div class="controls" style="justify-content:center; margin-top:12px">
        <button id="playSP" class="round play" title="Start/Gjenoppta" aria-label="Start">
          <span id="playSPIcon">‚ñ∂</span>
        </button>
        <button id="pauseSP" class="round pause" title="Pause" aria-label="Pause" disabled>‚ùö‚ùö</button>
        <button id="stopSP"  class="round stop"  title="Stopp/Nullstill" aria-label="Stopp" disabled>‚ñ†</button>
      </div>
    </div>
  </div>

  <!-- VAKTT√ÖRN -->
  <div id="viewWT" class="view">
    <div id="wtControlsCard" class="card infoband" style="justify-content:space-between; gap:12px">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <select id="langSel" class="select" aria-label="Spr√•k">
          <option value="no">Norsk</option>
          <option value="sv">Svenska</option>
        </select>
        <select id="weekSel" class="select" aria-label="Artikkel">
          <option>Laster ‚Ä¶</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <div class="pill" id="pillParas">Avsnitt: 0</div>
        <div class="pill" id="pillReads">Les-skriftsteder: 0</div>
      </div>
    </div>

    <div class="h1" id="articleTitle">‚Äî</div>
    <div class="message" id="message">Velg spr√•k og artikkel for √• laste timer.</div>

    <div class="timeline-wrap">
      <div id="timeline" class="timeline">
        <div id="introSlot"  class="slot" style="left:0%;width:0"></div>
        <div id="reviewSlot" class="slot" style="right:0;width:0"></div>
        <div id="outroSlot"  class="slot" style="right:0;width:0"></div>
        <div id="elapsed" class="elapsed"></div>
        <div id="cursor"  class="cursor"></div>
      </div>
      <div class="clock" id="clockWT">00:00</div>
    </div>

    <div class="controls">
      <button id="playWT"  class="round play"  title="Start/Gjenoppta" aria-label="Start">‚ñ∂</button>
      <button id="pauseWT" class="round pause" title="Pause" aria-label="Pause" disabled>‚ùö‚ùö</button>
      <button id="stopWT"  class="round stop"  title="Stopp" aria-label="Stopp" disabled>‚ñ†</button>
    </div>

    <!-- Notater -->
    <div class="card" style="margin-top:14px">
      <textarea id="wtNotes" rows="5" style="width:100%; border:1px solid var(--border); border-radius:12px; padding:10px; font:inherit; color:var(--ink); background:var(--pill);" placeholder="Her kan du notere."></textarea>
    </div>
  </div>

  <div class="footer">Meeting Timer ¬© 2025</div>
</div>

<script>
/* ===== helpers ===== */
const TOTAL=3600, INTRO=90, REVIEW=120, OUTRO=90, CONTENT=TOTAL-INTRO-REVIEW-OUTRO;
const WPM=150, SEC_PER_Q=10, SEC_PER_READ=30, AB_BONUS=30;
const $=s=>document.querySelector(s), pct=s=>s/TOTAL*100;
const fmt=s=>{s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60),r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0')}
function isoMonday(d=new Date()){ const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const w=(x.getUTCDay()+6)%7; x.setUTCDate(x.getUTCDate()-w); return x.toISOString().slice(0,10); }
function addDaysISO(iso,days){ const d=new Date(iso); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function labelFor(k,lang){ if(lang==='sv'){ if(k==='paras')return'Paragrafer'; if(k==='reads')return'L√§s-skriftst√§llen'; } if(k==='paras')return'Avsnitt'; if(k==='reads')return'Les-skriftsteder'; return k; }

/* ===== WT state ===== */
let lang='no', paras=[], perParagraph=[], cumulative=[], totalParagraphs=0, reads=0;
let started=false, paused=false, startTs=null, accum=0, tickHandle=null;
let wtShown10=false, wtTenTimer=null;

// WT message helpers
let wtMsgHoldTimer=null, wtMsgHoldUntil=0, wtLastE=0;
const WT_SMILE_MIN = [5,15,25,40,55];   // min etter start
const WT_CHEER_MIN = [2,10,20,35,45];   // min etter start
const wtSmileSeen = new Set();
const wtCheerSeen = new Set();

/* ===== data load ===== */
async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw 0; return r.json();}
async function loadYear(l,y){ for(const p of [`data/${l}-${y}.json`,`Data/${l}-${y}.json`,`data/${l}-${y}`,`Data/${l}-${y}`]){ try{ return await fetchJSON(p+`?v=${Date.now().toString().slice(7)}`);}catch{} } throw 0;}
async function hydrateOptions(){
  const today=new Date(); const year=today.getFullYear(); let items=[];
  try{ const list=[]; for(const yy of [year,year+1]){ try{ list.push(await loadYear(lang,yy)); }catch{} } items=list.flatMap(p=>Array.isArray(p)?p:(p?.items||[])); }catch{}
  const sel=$('#weekSel'); sel.innerHTML='';

  const cur=isoMonday(today), prev=addDaysISO(cur,-7), nexts=[7,14,21].map(d=>addDaysISO(cur,d));
  const want=[prev,cur,...nexts];
  const picked=(items||[]).filter(it=>want.includes(it.week_start)).sort((a,b)=>a.week_start.localeCompare(b.week_start));

  if(!picked.length){ const o=document.createElement('option'); o.textContent='Ingen artikler funnet (sjekk /data)'; o.disabled=true;o.selected=true; sel.appendChild(o); $('#message').textContent='Ingen data lastet.'; return; }

  picked.forEach(it=>{ const o=document.createElement('option'); o.value=JSON.stringify(it); o.textContent=it.title||'(uten tittel)'; sel.appendChild(o); });
  const idx=picked.findIndex(x=>x.week_start===cur); sel.selectedIndex = idx>-1 ? idx : 0;
  useItem(JSON.parse(sel.value));
}
function useItem(it){
  $('#articleTitle').textContent=it.title||'‚Äî';
  totalParagraphs=it.paragraphs|0; reads=it.reads|0;
  paras=(it.words||[]).map((w,i)=>({num:i+1,words:w|0,q:1,les:0,hasAB:false}));
  if(paras.length!==totalParagraphs){ paras=Array.from({length:totalParagraphs},(_,i)=>({num:i+1,words:0,q:1,les:0,hasAB:false})); }
  $('#pillParas').textContent=`${labelFor('paras',lang)}: ${totalParagraphs}`;
  $('#pillReads').textContent=`${labelFor('reads',lang)}: ${reads}`;
  computeAllocation(); drawTimeline(); resetClockUI();
  $('#message').textContent='Klar til start. Trykk ‚ñ∂ n√•r du er klar.'; $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true;
  wtShown10=false; if(wtTenTimer){clearTimeout(wtTenTimer);wtTenTimer=null;}
  if(wtMsgHoldTimer){ clearTimeout(wtMsgHoldTimer); wtMsgHoldTimer=null; }
  wtMsgHoldUntil=0; wtLastE=0; wtSmileSeen.clear(); wtCheerSeen.clear();
}

/* ===== allocation (¬±20% kant-bias) ===== */
function computeAllocation(){
  if(totalParagraphs<=0){perParagraph=[];cumulative=[];return;}
  const wps=WPM/60;
  const raw=Array.from({length:totalParagraphs},(_,i)=>{
    const p=paras[i]||{words:0,q:1,les:0,hasAB:false};
    let s=(p.words||0)/wps + (p.q||0)*SEC_PER_Q + (p.les||0)*SEC_PER_READ + (p.hasAB?AB_BONUS:0);
    s=Math.max(5,s);
    const firstN=Math.min(5,totalParagraphs), lastN=Math.min(5,totalParagraphs);
    if(i < firstN) s*=0.8;
    if(i >= totalParagraphs-lastN) s*=1.2;
    return s;
  });
  const scale=CONTENT/((raw.reduce((a,b)=>a+b,0))||1);
  perParagraph=raw.map(x=>x*scale);
  cumulative=[]; let acc=INTRO; for(let i=0;i<totalParagraphs;i++){cumulative.push(acc); acc+=perParagraph[i];}
}

/* ===== timeline (WT) ===== */
function drawTimeline(){
  const t=$('#timeline'); Array.from(t.querySelectorAll('.para-slot')).forEach(n=>n.remove());
  $('#introSlot').style.left='0%'; $('#introSlot').style.width=pct(INTRO).toFixed(4)+'%';
  $('#outroSlot').style.right='0%'; $('#outroSlot').style.width=pct(OUTRO).toFixed(4)+'%';
  $('#reviewSlot').style.right=pct(OUTRO).toFixed(4)+'%'; $('#reviewSlot').style.width=pct(REVIEW).toFixed(4)+'%';
  if(totalParagraphs<=0){$('#elapsed').style.width='0%'; $('#cursor').style.left='0%'; return;}

  const tlWidth = t.clientWidth;
  const pxPerSec = tlWidth / TOTAL;
  for(let i=1;i<=totalParagraphs;i++){
    const leftP=pct(cumulative[i-1]), widthP=pct(perParagraph[i-1]);
    const slot=document.createElement('div'); slot.className='para-slot'+(i%2===0?' alt':'');
    slot.style.left=leftP+'%'; slot.style.width=widthP+'%';

    // ALLTID vis nummer ‚Äì dynamisk skrift
    const slotPx = perParagraph[i-1]*pxPerSec;
    const lbl=document.createElement('div');
    lbl.textContent=String(i);
    const fs = Math.max(9, Math.min(14, Math.floor(slotPx*0.33)));
    lbl.style.fontSize = fs+'px';
    slot.appendChild(lbl);

    slot.addEventListener('click',()=>{ if(started && !paused) return; const target=cumulative[i-1]; accum=Math.min(Math.round(target), TOTAL-OUTRO-REVIEW); const pNow=Math.min(accum/TOTAL*100,100); $('#elapsed').style.width=pNow+'%'; $('#cursor').style.left=`calc(${pNow}% - 1px)`; $('#clockWT').textContent=fmt(accum); $('#clockWT').classList.toggle('over',accum>=TOTAL); $('#message').textContent=`${labelFor('paras',lang)} ${i}`; });
    t.insertBefore(slot,$('#elapsed'));
  }
  $('#elapsed').style.width='0%'; $('#cursor').style.left='0%';
}
let _rAF=null;
function relayout(){ if(totalParagraphs>0) drawTimeline(); drawTimelineSP(); }
['resize','orientationchange'].forEach(ev=>{
  window.addEventListener(ev, ()=>{
    if(_rAF) cancelAnimationFrame(_rAF);
    _rAF = requestAnimationFrame(relayout);
  });
});

/* ===== WT clock + meldinger ===== */
function resetClockUI(){ if(tickHandle)clearInterval(tickHandle); $('#clockWT').textContent='00:00'; $('#clockWT').classList.remove('over')}
function startClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=setInterval(tickWT,250)}
function stopClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=null}
function nowElapsed(){ if(!started) return accum; if(paused) return accum; return accum+Math.floor((Date.now()-startTs)/1000)}
function setWTMessage(txt){ $('#message').textContent=txt; }
function wtFlash(msg, ms=10000){
  setWTMessage(msg);
  wtMsgHoldUntil = Date.now() + ms;
  if(wtMsgHoldTimer) clearTimeout(wtMsgHoldTimer);
  wtMsgHoldTimer = setTimeout(()=>{ wtMsgHoldTimer=null; }, ms);
}
function tickWT(){
  const e=nowElapsed(), remaining = TOTAL - e;
  $('#clockWT').textContent=fmt(e); $('#clockWT').classList.toggle('over',e>=TOTAL);
  const p=Math.min(e/TOTAL*100,100); $('#elapsed').style.width=p+'%'; $('#cursor').style.left=`calc(${p}% - 1px)`;

  // 10 min igjen ‚Üí ny tekst (20 sek)
  if(!wtShown10 && remaining<=600 && remaining>0){
    wtShown10 = true;
    wtFlash('10 min igjen, dette klarer du! üòé', 20000);
  }

  // hold midlertidig melding hvis aktiv
  if(wtMsgHoldTimer && Date.now()<wtMsgHoldUntil){ wtLastE = e; return; }

  // Korte ‚Äúsmil/heia‚Äù-popups
  const crossed = (arr, seen, msg)=>{ for(const m of arr){ const s=m*60; if(!seen.has(m) && wtLastE < s && e >= s){ seen.add(m); wtFlash(msg, 10000); break; } } };
  crossed(WT_SMILE_MIN, wtSmileSeen, 'Husk √• smile! üòÅ');
  crossed(WT_CHEER_MIN, wtCheerSeen, 'Jeg heier p√• deg! ü§©');

  if(e<INTRO) setWTMessage('Introduksjon');
  else if(e>=TOTAL) setWTMessage('Tiden er brukt ‚Äì teller over');
  else if(e>=TOTAL-OUTRO) setWTMessage('Avslutning');
  else if(e>=TOTAL-OUTRO-REVIEW) setWTMessage('Repetisjonssp√∏rsm√•l');
  else{
    let idx=0; for(let i=0;i<totalParagraphs;i++){const s=cumulative[i], end=(i===totalParagraphs-1)?(TOTAL-OUTRO-REVIEW):cumulative[i+1]; if(e>=s&&e<end){idx=i;break}}
    let msg=`${labelFor('paras',lang)} ${idx+1}`;
    if(e>=1800&&e<1860) msg+=' ‚Äì du er halvveis';
    setWTMessage(msg);
  }
  wtLastE = e;
}
/* WT controls + hide controls card while running + stop-feedback */
$('#playWT').addEventListener('click',()=>{
  if(started && paused){
    paused=false; startTs=Date.now(); startClock();
    $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false;
    return;
  }
  if(!started){
    started=true; paused=false; startTs=Date.now(); startClock(); setWTMessage('Introduksjon');
    $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false; $('#wtControlsCard').classList.add('hiddenCard');
  }
});
$('#pauseWT').addEventListener('click',()=>{ if(!started||paused) return; accum+=Math.floor((Date.now()-startTs)/1000); paused=true; stopClock(); setWTMessage('Pause'); $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=false; });
$('#stopWT').addEventListener('click',()=>{ 
  if(started&&!paused) accum+=Math.floor((Date.now()-startTs)/1000);
  started=false; paused=false; stopClock();
  const e=accum;
  // Stoppe-kommentarer:
  if(e>=3300 && e<3600) setWTMessage('Godt jobbet, du klarte det p√• under en time! ü•≥');
  else if(e>=3600 && e<3720) setWTMessage('Nesten helt perfekt! ü§©');
  else if(e>=3720 && e<3900) setWTMessage('Litt over, neste gang klarer du enda bedre. üëç');
  else if(e>=3900 && e<4200) setWTMessage('Aj aj, her har du litt √• jobbe med. üòÖ');
  else setWTMessage(`Ferdig ‚Äì totalt ${fmt(e)}`);

  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true; accum=0; resetClockUI(); $('#elapsed').style.width='0%'; $('#cursor').style.left='0%'; $('#wtControlsCard').classList.remove('hiddenCard');
  wtShown10=false; if(wtTenTimer){clearTimeout(wtTenTimer);wtTenTimer=null;}
  if(wtMsgHoldTimer){ clearTimeout(wtMsgHoldTimer); wtMsgHoldTimer=null; }
  wtMsgHoldUntil=0; wtLastE=0; wtSmileSeen.clear(); wtCheerSeen.clear();
});

/* ===== Tabs & icons ===== */
const views={WT:$('#viewWT'), SP:$('#viewSP')}, tabs={WT:$('#tabWT'), SP:$('#tabSP')};
function activateView(k){
  Object.entries(views).forEach(([x,el])=>el.classList.toggle('active',x===k));
  Object.entries(tabs).forEach(([x,b])=>{
    b.classList.toggle('active',x===k);
    b.setAttribute('aria-selected',x===k?'true':'false');
  });
}
$('#tabWT').addEventListener('click',()=>activateView('WT'));
$('#tabSP').addEventListener('click',()=>activateView('SP'));
// other-icon fallback .ng
const otherIcon = document.getElementById('otherIcon');
otherIcon.addEventListener('error', ()=>{ if(!otherIcon.dataset.triedNg){ otherIcon.src='other-icon.ng'; otherIcon.dataset.triedNg='1'; }});

/* ===== Spr√•k + uke ===== */
$('#langSel').addEventListener('change', async ()=>{ lang=$('#langSel').value||'no'; await hydrateOptions(); localStorage.setItem('meetingTimer.lang',lang);
  $('#pillParas').textContent=`${labelFor('paras',lang)}: ${totalParagraphs}`;
  $('#pillReads').textContent=`${labelFor('reads',lang)}: ${reads}`; });
$('#weekSel').addEventListener('change',()=>{ const v=$('#weekSel').value; if(!v) return; useItem(JSON.parse(v)); });

/* ===== TALER (nedtelling / count-up) ===== */
const PRESET_KEY='meetingTimer.annetSeconds';
const spPresets=Array.from(document.querySelectorAll('.preset-row .preset'));
let spRunning=false, spPaused=false, spStart=null, spAccum=0, spTick=null;
let SP_TOTAL=parseInt(localStorage.getItem(PRESET_KEY),10);
if(isNaN(SP_TOTAL)) SP_TOTAL=0; // start p√• 0 => count-up
let shownOneMin=false, shownOver=false, prevRemain=null;
let spMsgTimers=[];
let spShownStartMsg=false, spShown2min=false;

function isCountUp(){ return SP_TOTAL===0; }
function spFmt(s){s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0')}
function spElapsed(){ if(!spRunning) return spAccum; if(spPaused) return spAccum; return spAccum+Math.floor((Date.now()-spStart)/1000) }
function markPreset(s){ spPresets.forEach(b=>b.classList.toggle('active',parseInt(b.dataset.sec,10)===s)) }
function updatePlayIcon(){
  const iconEl = document.getElementById('playSPIcon');
  iconEl.textContent = isCountUp() ? '‚è±Ô∏è' : '‚ñ∂';
}
function applyIdleClock(){
  $('#clockSP').classList.remove('over');
  if(isCountUp()) $('#clockSP').textContent='00:00';
  else $('#clockSP').textContent=spFmt(SP_TOTAL);
}
function resetFlags(){
  shownOneMin=false; shownOver=false; prevRemain=null; spMsgTimers.forEach(t=>clearTimeout(t)); spMsgTimers=[];
  spShownStartMsg=false; spShown2min=false;
}

function drawTimelineSP(){
  // Count-up: 30 min skala. Count-down: valgt tid.
  const totalScale = isCountUp() ? 1800 : SP_TOTAL; // 1800 = 30 min
  const e = spElapsed();
  let progress;
  if (isCountUp()) progress = Math.min(1, e / totalScale);
  else { const remain = SP_TOTAL - e; progress = Math.max(0, Math.min(1, remain / totalScale)); }
  $('#elapsedSP').style.width = (progress*100)+'%';
  $('#cursorSP').style.left  = `calc(${progress*100}% - 1px)`;
}
function showMilestone(name){
  const el=$('#msImg');
  if(!name){ el.style.display='none'; el.classList.remove('show'); el.removeAttribute('src'); return; }
  const onerr=()=>{ el.style.display='none'; el.classList.remove('show'); el.onerror=null; };
  el.onerror=onerr;
  el.onload=()=>{ el.style.display='block'; requestAnimationFrame(()=>el.classList.add('show')); };
  el.src=name;
}
function setSPMessage(txt, ms=null){ $('#msgSP').textContent=txt||''; if(ms){ const id=setTimeout(()=>{$('#msgSP').textContent='';}, ms); spMsgTimers.push(id); } }

function updateSP(){
  const e=spElapsed();

  if(spRunning && !spPaused){
    if(!spShownStartMsg){ setSPMessage('Vi er i gang! ‚ò∫Ô∏è', 10000); spShownStartMsg=true; }
    if(e>=120 && !spShown2min){ setSPMessage('Wow, du er flink! üòç', 20000); spShown2min=true; }

    if(!isCountUp()){
      const remain = SP_TOTAL - e;
      if(remain===60 && !shownOneMin){ setSPMessage('Snart ferdig n√•! ‚è±Ô∏è'); shownOneMin=true; }
      if(remain<0 && !shownOver){ setSPMessage('Oj, du har g√•tt over tiden. üòÖ'); shownOver=true; }

      // milestone-bilder ved 30/15/10/5 min igjen
      const crossed = th => (prevRemain!==null && prevRemain>th && remain<=th);
      if(crossed(1800)) showMilestone('milestone-30.png');
      if(crossed( 900)) showMilestone('milestone-15.png');
      if(crossed( 600)) showMilestone('milestone-10.png');
      if(crossed( 300)) showMilestone('milestone-5.png');
      prevRemain=remain;
    }
  }

  // klokke
  if(isCountUp()){
    $('#clockSP').classList.remove('over'); $('#clockSP').textContent=spFmt(e);
  }else{
    const remain=SP_TOTAL-e;
    if(remain>=0){ $('#clockSP').classList.remove('over'); $('#clockSP').textContent=spFmt(remain); }
    else{ $('#clockSP').classList.add('over'); $('#clockSP').textContent=spFmt(-remain); }
  }
  drawTimelineSP();
}

function spStartFn(){
  if(spRunning && spPaused){
    spPaused=false; spStart=Date.now();
    spTick&&clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false;
    return;
  }
  if(!spRunning){
    spRunning=true; spPaused=false; spStart=Date.now(); spAccum=0;
    setSPMessage('Vi er i gang! ‚ò∫Ô∏è', 10000);
    resetFlags();
    $('#spInputs').classList.add('hiddenSoft'); // skjul presets/slider
    spTick&&clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false;

    // Start-bilde
    if(!isCountUp()){
      if(SP_TOTAL===1800) showMilestone('milestone-30.png');
      else if(SP_TOTAL===900) showMilestone('milestone-15.png');
      else if(SP_TOTAL===600) showMilestone('milestone-10.png');
      else if(SP_TOTAL===300) showMilestone('milestone-5.png');
      else showMilestone('milestone-other.png');
    }else{
      showMilestone('milestone-other.png');
    }

    updateSP();
  }
}
function spPauseFn(){ if(!spRunning||spPaused) return; spAccum+=Math.floor((Date.now()-spStart)/1000); spPaused=true; spTick&&clearInterval(spTick); spTick=null; $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=false; updateSP(); }
function spStopFn(){
  if(spRunning&&!spPaused) spAccum+=Math.floor((Date.now()-spStart)/1000);
  spRunning=false; spPaused=false; spStart=null; spAccum=0; prevRemain=null; spTick&&clearInterval(spTick); spTick=null;
  setSPMessage('Godt jobbet! üëè'); // stopp-beskjed
  showMilestone('milestone-stop.png'); // stop-bilde
  $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=true;
  $('#clockSP').classList.remove('over');
  // Ikke reset klokketekst ‚Äì la siste verdi st√•
  $('#spInputs').classList.remove('hiddenSoft');
}

$('#playSP').addEventListener('click',spStartFn);
$('#pauseSP').addEventListener('click',spPauseFn);
$('#stopSP').addEventListener('click',spStopFn);

/* Presets ‚Äì oppdat√©r ogs√• play-ikonet */
spPresets.forEach(btn=>btn.addEventListener('click',()=>{
  if(spRunning) return;
  const s=parseInt(btn.dataset.sec,10)||0;
  localStorage.setItem(PRESET_KEY,String(s));
  SP_TOTAL = s;
  markPreset([0,300,600,900,1800].includes(SP_TOTAL)?SP_TOTAL:-1);
  applyIdleClock();
  updatePlayIcon();
  showMilestone(null);
  drawTimelineSP();
}));

/* Slider-dial */
let dialValue = Math.min(60, Math.max(0, isNaN(SP_TOTAL)?0:Math.floor(SP_TOTAL/60)));
const dial = document.querySelector('.dial'), ticks = document.getElementById('ticks'), thumb = document.getElementById('thumb');
function renderTicks(){
  ticks.innerHTML = '';
  const start = Math.max(0, dialValue-3), end = Math.min(60, dialValue+3);
  for(let m=start; m<=end; m++){
    const el=document.createElement('span'); el.textContent=String(m);
    if(m===dialValue) el.className='active';
    else if(Math.abs(m-dialValue)===1) el.className='near';
    ticks.appendChild(el);
  }
}
function positionThumb(){
  const track = dial.querySelector('.track');
  const rect = track.getBoundingClientRect();
  const pct = dialValue/60; // 0..1
  thumb.style.left = ((pct*100)) + '%';
}
function setDial(val){
  if(spRunning) return;
  dialValue = Math.min(60, Math.max(0, val|0));
  SP_TOTAL = dialValue*60;
  localStorage.setItem(PRESET_KEY,String(SP_TOTAL));
  markPreset([0,300,600,900,1800].includes(SP_TOTAL)?SP_TOTAL:-1);
  renderTicks(); positionThumb();
  applyIdleClock();
  updatePlayIcon();
  showMilestone(null); $('#msgSP').textContent='';
  drawTimelineSP();
}
renderTicks(); positionThumb();

(function(){
  const track = dial.querySelector('.track');
  let drag=false;
  function setFromClientX(x){
    const r=track.getBoundingClientRect(), pct = Math.min(1, Math.max(0, (x-r.left)/r.width));
    setDial(Math.round(pct*60));
  }
  track.addEventListener('pointerdown',e=>{drag=true; track.setPointerCapture(e.pointerId); setFromClientX(e.clientX);});
  track.addEventListener('pointermove',e=>{ if(drag) setFromClientX(e.clientX); });
  track.addEventListener('pointerup',()=>{drag=false;});
})();
document.getElementById('minInc').addEventListener('click',()=> setDial(dialValue+1));
document.getElementById('minDec').addEventListener('click',()=> setDial(dialValue-1));

/* Logo effekt */
const brandBox=document.getElementById('brandBox'), logoImg=document.getElementById('logoImg');
logoImg.addEventListener('click',()=>{
  brandBox.classList.remove('explode'); logoImg.classList.remove('shake');
  void brandBox.offsetWidth; void logoImg.offsetWidth;
  brandBox.classList.add('explode');
  logoImg.classList.add('shake');
});

/* Init */
(async function init(){
  // Taler init
  markPreset([0,300,600,900,1800].includes(SP_TOTAL)?SP_TOTAL:-1);
  applyIdleClock();
  updatePlayIcon();
  drawTimelineSP();

  // WT init
  const savedLang=localStorage.getItem('meetingTimer.lang'); if(savedLang) $('#langSel').value=savedLang; lang=$('#langSel').value||'no';
  await hydrateOptions();
})();
</script>
</body>
</html>
