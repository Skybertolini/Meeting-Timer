<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Study Timer</title>
<style>
  :root{
    --green:#28a745;
    --blue:#0d6efd;
    --orange:#ff8800;
    --elapsed-fill: rgba(220, 20, 20, 0.35);
    --elapsed-line: #cc0000;
    --msg-border:#28a745;
    --msg-shadow: rgba(40,167,69,.25);
    --stop-red:#d21f3c;
    --muted:#9aa3ab;
  }
  body{ font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:24px; display:flex; flex-direction:column; align-items:center; }
  h1{ display:flex; align-items:center; gap:10px; font-size:2rem; margin:0 0 10px; }
  h1::before{ content:"⏱️"; }
  .container{ width:min(960px,94vw); }

  label{ color:#333; font-size:.95rem; }
  textarea{
    width:100%; height:180px; resize:vertical; padding:12px; font-size:1rem;
    border:1px solid #cfd4da; border-radius:10px; background:#fff; transition: all .25s ease;
  }
  textarea.collapsed{ height:72px !important; color:var(--muted) !important; background:#fafafa !important; }

  .btn{ background:var(--green); color:#fff; border:0; padding:12px 18px; border-radius:10px; cursor:pointer; font-size:1rem; margin:10px 10px 0 0; }
  .btn:disabled{ background:#9aa3ab; cursor:not-allowed; }
  .btn.done{ background:var(--green) !important; cursor:default; }
  .btn.done::before{ content:"✓ "; font-weight:700; }

  .info-line{ display:flex; flex-wrap:wrap; align-items:center; gap:14px; margin-top:10px; }
  .inline-edit{ display:inline-flex; align-items:center; gap:8px; background:#fff; border:1px solid #cfd4da; border-radius:10px; padding:8px 10px; }
  .inline-edit input{ width:90px; padding:6px 8px; font-size:1rem; border:1px solid #cfd4da; border-radius:8px; background:#fff; }
  .inline-edit input.ghost{ color:var(--muted) !important; }

  .title{ font-size:1.25rem; font-weight:700; margin-top:14px; }
  .message-box{ margin-top:12px; padding:14px 18px; background:#fff; border:2px solid var(--msg-border); border-radius:12px; font-size:1.1rem; color:#0c2915; box-shadow:0 4px 16px var(--msg-shadow); min-height:1.2em; }

  .timeline-wrap{ width:100%; margin-top:28px; }
  .timeline{ position:relative; height:48px; border-radius:12px; background:#eaf6ec; border:2px solid var(--green); overflow:visible; }
  .slot{ position:absolute; top:0; height:100%; opacity:.20; }
  .elapsed{ position:absolute; top:0; left:0; height:100%; background:var(--elapsed-fill); width:0%; transition: width .25s linear; }
  .cursor{ position:absolute; top:-10px; width:3px; height:68px; background:var(--elapsed-line); left:0%; }
  .tick{ position:absolute; top:50%; transform:translate(-50%,-50%); width:10px; height:10px; border-radius:50%; background:#1f7a33; border:1px solid #0f3d1a; }
  .tick-label{ position:absolute; left:50%; transform:translateX(-50%); font-size:.74rem; color:#0c2915; }
  .tick-label.odd{ top:-20px; } .tick-label.even{ bottom:-20px; }

  /* Klokke: større og mer luft til tidslinjen */
  #clock{ margin-top:20px; font-size:1.9rem; font-weight:800; color:#28a745; }
  #clock.over{ color:#e11900; }

  .footer{ margin-top:22px; width:100%; display:flex; justify-content:flex-start; align-items:center; gap:14px; }
  .round-btn{ display:inline-flex; align-items:center; justify-content:center; width:50px; height:50px; border-radius:50%; border:0; cursor:pointer;
              box-shadow:0 4px 12px rgba(0,0,0,.25), inset 0 -3px 0 rgba(0,0,0,.08); transition: transform .04s ease; }
  .round-btn:active{ transform:translateY(1px) scale(0.97); }
  .play-btn{ background:var(--green); }
  .play-btn::before{ content:"▶"; color:#fff; font-size:1.5rem; margin-left:3px; }
  .stop-btn{ background:var(--stop-red); }
  .stop-btn::before{ content:""; display:block; width:16px; height:16px; background:#fff; border-radius:2px; }
  .play-btn:disabled, .stop-btn:disabled{ background:#aaa; cursor:not-allowed; box-shadow:none; }

  /* Notatfelt og footer */
  .notes-section{ margin-top:32px; }
  .notes-section label{ font-weight:600; display:block; margin-bottom:6px; }
  .notes-section textarea{ height:120px; }
  .copyright{ margin-top:24px; font-size:.9rem; color:#777; text-align:center; }
</style>
</head>
<body>
  <div class="container">
    <h1>Study Timer</h1>

    <!-- Instruks -->
    <label for="articleText">Gå til wol.jw.org og finn ukens vakttårnstudieartikkel. Kopier all tekst derfra.</label>
    <textarea id="articleText" placeholder="Lim inn hele teksten her."></textarea>
    <button id="analyzeBtn" class="btn">Analyser</button>

    <!-- Redigerbar info + juster -->
    <div class="info-line">
      <div class="inline-edit">
        <label for="editParagraphs">Avsnitt</label>
        <input id="editParagraphs" type="number" min="1" value="0" class="ghost">
      </div>
      <div class="inline-edit">
        <label for="editQuestions">Spørsmål</label>
        <input id="editQuestions" type="number" min="0" value="0" class="ghost">
      </div>
      <div class="inline-edit">
        <label for="editScriptures">Les-skriftsteder</label>
        <input id="editScriptures" type="number" min="0" value="0" class="ghost">
      </div>
      <button id="adjustBtn" class="btn" disabled>Juster</button>
    </div>

    <!-- Tittel + meldinger -->
    <div id="articleTitle" class="title"></div>
    <div id="message" class="message-box">Begynn med å lime inn artikkelserien og analysere den.</div>

    <!-- Tidslinje -->
    <div class="timeline-wrap">
      <div id="timeline" class="timeline">
        <div id="introSlot"  class="slot" style="background:var(--blue)"></div>
        <div id="reviewSlot" class="slot" style="background:var(--orange)"></div>
        <div id="outroSlot"  class="slot" style="background:var(--blue)"></div>
        <div id="elapsed" class="elapsed"></div>
        <div id="cursor"  class="cursor"></div>
      </div>
      <div id="clock" class="clock">00:00</div>
    </div>

    <!-- Kontrollpanel -->
    <div class="footer">
      <button id="playBtn" class="round-btn play-btn" disabled title="Start studiet"></button>
      <button id="stopBtn" class="round-btn stop-btn" disabled title="Ferdig"></button>
    </div>

    <!-- Notater -->
    <div class="notes-section">
      <label for="notes">Notater</label>
      <textarea id="notes" placeholder="Skriv notater her..."></textarea>
    </div>

    <!-- Copyright -->
    <div class="copyright">Study Timer © 2025</div>
  </div>

<script>
  // --- Delte regexer (NBSP-støtte) ---
  const HEADER_RE     = /^(\d+(?:[\s\u00A0]*,[\s\u00A0]*\d+)*)\.\s*(.*)?$/;
  const BODY_START_RE = /^(\d+)[\.\s\u00A0]+(.*)$/;

  // --- Konstanter ---
  const TOTAL_SEC   = 3600; // 60:00
  const INTRO_SEC   = 90;   // 1:30
  const REVIEW_SEC  = 120;  // 2:00 repetisjonsspørsmål
  const OUTRO_SEC   = 90;   // 1:30
  const CONTENT_SEC = TOTAL_SEC - INTRO_SEC - REVIEW_SEC - OUTRO_SEC; // 3300

  // Smart-modus (alltid på)
  const WPM         = 150;  // ord/min
  const SEC_PER_Q   = 10;   // +sek per spørsmål
  const SEC_PER_LES = 30;   // +sek per "Les …"
  const AB_BONUS    = 60;   // +1 min ved (a) & (b)

  const pct = (sec) => (sec / TOTAL_SEC) * 100;
  const $ = (id) => document.getElementById(id);

  // --- Tilstand ---
  let paras = [];        // {num, text, words, q, les, hasAB}
  let totalParagraphs = 0;
  let questions = 0;
  let scriptures = 0;
  let perParagraph = []; // sek pr avsnitt
  let cumulative = [];   // startsek pr avsnitt (etter intro)

  let started = false;
  let startTs = null;
  let tickHandle = null;
  let lastMilestone = "";

  // --- Lyttere ---
  $('analyzeBtn').addEventListener('click', onAnalyze);
  $('playBtn').addEventListener('click', onPlay);
  $('stopBtn').addEventListener('click', onStop);
  ['editParagraphs','editQuestions','editScriptures'].forEach(id=>{
    $(id).addEventListener('input', e => e.target.classList.remove('ghost'));
    $(id).addEventListener('change', e => e.target.classList.remove('ghost'));
  });
  $('adjustBtn').addEventListener('click', onAdjust);

  // --- Handlers ---
  function onAnalyze(){
    const raw = $('articleText').value.trim();
    if(!raw){ alert('Lim inn teksten først.'); return; }

    analyzeText(raw);

    // UI etter analyse – Safari-proof
    const ta = $('articleText');
    ta.classList.add('collapsed');
    ta.style.height = '72px';
    ta.style.color = '#9aa3ab';
    ta.style.background = '#fafafa';
    ta.blur();

    // "Analyser" -> grønn hake
    const ab = $('analyzeBtn');
    ab.textContent = '';
    ab.classList.add('done');
    ab.disabled = true;

    if (totalParagraphs > 0){
      setMessage('Alt er klart. Trykk Play for å starte studiet.');
      $('playBtn').disabled = false;
      $('stopBtn').disabled = true;
    } else {
      setMessage('Fant ingen avsnitt. Sjekk at avsnittene starter med tall (f.eks. «1.» eller «6, 7.») og prøv igjen.');
      $('playBtn').disabled = true;
      $('stopBtn').disabled = true;
    }
  }

  function onPlay(){
    if (started) return;
    started = true;
    $('playBtn').disabled = true;
    $('stopBtn').disabled = false;
    setMessage('Introduksjon');
    startClock();
  }

  function onStop(){
    if (!started) return;
    const elapsed = Math.floor((Date.now() - startTs)/1000);
    stopClock();
    setMessage(`Studiet ferdig — tid brukt: ${fmt(elapsed)}`);
    started = false;
    $('playBtn').disabled = true;
    $('stopBtn').disabled = true;
  }

  function onAdjust(){
    const pVal = parseInt($('editParagraphs').value, 10);
    const qVal = parseInt($('editQuestions').value, 10);
    const sVal = parseInt($('editScriptures').value, 10);

    if(!isNaN(pVal) && pVal > 0 && pVal !== totalParagraphs){
      totalParagraphs = pVal;
      if (paras.length > totalParagraphs) {
        paras = paras.slice(0, totalParagraphs);
      } else {
        while (paras.length < totalParagraphs) {
          paras.push({num: paras.length+1, text:'', words:0, q:0, les:0, hasAB:false});
        }
      }
      computeAllocation();
      drawTimeline();
    }
    if(!isNaN(qVal) && qVal >= 0) questions = qVal;
    if(!isNaN(sVal) && sVal >= 0) scriptures = sVal;

    updateInfoLine(false);
  }

  // --- Analyse & parsing ---
  function analyzeText(text){
    // Normaliser NBSP til vanlig mellomrom for enklere matching
    const norm = text.replace(/\u00A0/g, ' ');
    const lines = norm.split('\n').map(l => l.trim()).filter(Boolean);

    const title = pickTitle(lines);
    $('articleTitle').textContent = title || 'Ukens studieartikkel';

    paras = extractParagraphs(lines);
    totalParagraphs = paras.length;
    questions = paras.reduce((s,p)=> s + p.q, 0);
    scriptures = paras.reduce((s,p)=> s + p.les, 0);

    computeAllocation();
    drawTimeline();
    updateInfoLine(true);
    resetClockUI();
  }

  // --- NY: tittel-funksjon med SANG-heuristikk + fallback ---
  function pickTitle(lines){
    const blacklist = /^(Publikasjoner|STUDIEARTIKKEL\b|SANG\b|FOKUS\b|Underoverskrifter|Lignende stoff|Audio Player|Norsk\b|Del\b|Innstillinger\b|Logg inn\b|JW\.ORG\b|HVA SVARER DU\b|w\d{2}\b)/i;
    const looksLikeThemeText = /^\s*(«.+»|".+")\s*—\s*[1-3]?\s*[A-ZÆØÅ][a-zæøå. ]*\d/; // «…» — 1. MOS 49:1.

    const tooManyWords = l => l.split(/\s+/).length > 16;

    // 1) Prøv: rett etter SANG-linjen
    const idxSang = lines.findIndex(l => /^SANG[\s\u00A0]*\d+/i.test(l));
    if (idxSang >= 0){
      for (let j = idxSang + 1; j < Math.min(lines.length, idxSang + 8); j++){
        const c = (lines[j] || '').trim();
        if (!c) continue;
        if (blacklist.test(c)) continue;
        if (/^\d/.test(c)) continue;              // ikke starte med siffer
        if (!/[A-Za-zÆØÅæøå]/.test(c)) continue;  // må ha bokstaver
        if (!/[a-zæøå]/.test(c)) continue;        // ikke bare caps
        if (looksLikeThemeText.test(c)) continue; // hopp over tema-skriftstedlinje
        if (tooManyWords(c)) continue;
        if (c.length < 6 || c.length > 160) continue;
        return c;
      }
    }

    // 2) Fallback: plukk før første nummererte avsnitt
    const firstParaIdx = lines.findIndex(l => HEADER_RE.test(l) || BODY_START_RE.test(l));
    const headerZone = firstParaIdx > -1 ? lines.slice(0, firstParaIdx) : lines.slice(0, 30);

    const candidates = headerZone.filter(l => {
      if (blacklist.test(l)) return false;
      if (/^\d/.test(l)) return false;
      if (!/[A-Za-zÆØÅæøå]/.test(l)) return false;
      if (!/[a-zæøå]/.test(l)) return false;
      if (looksLikeThemeText.test(l)) return false;
      if (tooManyWords(l)) return false;
      if (l.length < 6 || l.length > 160) return false;
      return true;
    });

    if (candidates.length === 0) return '';

    const score = s =>
      (/[–—-]/.test(s) ? 3 : 0) +
      (/:/.test(s) ? 1 : 0) +
      Math.max(0, 16 - s.split(/\s+/).length);

    candidates.sort((a,b)=> score(b) - score(a));
    return candidates[0];
  }

  function extractParagraphs(lines){
    const out = [];
    let pendingNums = [];
    let pendingAB  = false;
    let currentNum = null;
    let currentAB  = false;
    let buf = [];

    const skipLineRe  = /^(HVA SVARER DU|Svaret ditt)$/i;

    const pushPara = ()=>{
      if(currentNum!==null){
        const text = buf.join(' ').trim();
        const words = (text.match(/\S+/g) || []).length;
        const q = (text.match(/\?/g) || []).length;

        // tell "Les" instruksjoner (ikke per vers, men per instruks)
        const lesInstr = (text.match(/\bLes\b/gi) || []).length;

        out.push({num: currentNum, text, words, q, les: lesInstr, hasAB: currentAB});
      }
      buf = [];
    };

    for (let raw of lines){
      const l = raw.trim();
      if(!l) continue;
      if(skipLineRe.test(l)) continue;

      const h = l.match(HEADER_RE);
      if(h){
        pushPara();
        pendingNums = h[1].split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n));
        const headText = (h[2]||'');
        const hasA = /\(a\)/i.test(headText);
        const hasB = /\(b\)/i.test(headText);
        pendingAB = (hasA && hasB);

        if(pendingNums.length){
          currentNum = pendingNums.shift();
          currentAB = pendingAB;
        } else {
          currentNum = null;
          currentAB = false;
        }
        if(headText) buf.push(headText);
        continue;
      }

      const b = l.match(BODY_START_RE);
      if(b){
        const n = parseInt(b[1],10);
        const rest = (b[2]||'').trim();

        if(pendingNums.length && n === pendingNums[0]){
          pushPara();
          currentNum = pendingNums.shift();
          currentAB = pendingAB;
          if(rest) buf.push(rest);
          continue;
        }

        if(currentNum===null || n !== currentNum){
          pushPara();
          currentNum = n;
          currentAB = false;
          if(rest) buf.push(rest);
          continue;
        }

        if(rest) buf.push(rest);
        continue;
      }

      buf.push(l);
    }
    pushPara();

    // Sortér/merge på nummer
    const seen = new Set();
    const cleaned = [];
    for (const p of out.sort((a,b)=>a.num-b.num)){
      if(!seen.has(p.num)){ cleaned.push(p); seen.add(p.num); }
      else {
        const last = cleaned[cleaned.length-1];
        last.text += ' ' + p.text;
        last.words = (last.text.match(/\S+/g) || []).length;
        last.q += p.q;
        last.les += p.les;
        last.hasAB = last.hasAB || p.hasAB;
      }
    }

    // fallback (svært sjelden)
    if (cleaned.length === 0){
      const joined = lines.join('\n');
      const rough = joined.split(/\n(?=\d+[.]\s)/).filter(s => /^\d+[.]\s/.test(s));
      rough.forEach((block, i)=> {
        const text = block.replace(/^\d+[.]\s*/, '');
        const words = (text.match(/\S+/g) || []).length;
        const q = (text.match(/\?/g) || []).length;
        const lesInstr = (text.match(/\bLes\b/gi) || []).length;
        cleaned.push({num:i+1, text, words, q, les: lesInstr, hasAB:false});
      });
    }
    return cleaned;
  }

  // --- Fordeling & timeline ---
  function computeAllocation(){
    if(totalParagraphs === 0){ perParagraph=[]; cumulative=[]; return; }

    let list = paras.slice(0, totalParagraphs);
    if (list.length < totalParagraphs){
      while(list.length < totalParagraphs) list.push({num:list.length+1, text:'', words:0, q:0, les:0, hasAB:false});
    }

    const wps = WPM / 60;
    const raw = list.map(p => {
      let sec = 0;
      sec += (p.words || 0) / wps;
      sec += (p.q || 0) * SEC_PER_Q;
      sec += (p.les || 0) * SEC_PER_LES; // pr "Les"-instruks
      if (p.hasAB) sec += AB_BONUS;
      if (sec < 5) sec = 5;
      return sec;
    });

    const sumRaw = raw.reduce((a,b)=>a+b,0) || 1;
    const scale  = CONTENT_SEC / sumRaw;
    perParagraph = raw.map(x => x*scale);

    cumulative = [];
    let acc = INTRO_SEC;
    for (let i=0;i<totalParagraphs;i++){
      cumulative.push(acc);
      acc += perParagraph[i];
    }
  }

  function drawTimeline(){
    const t = $('timeline');
    Array.from(t.querySelectorAll('.tick,.tick-label')).forEach(n => n.remove());

    $('introSlot').style.left  = '0%';
    $('introSlot').style.width = pct(INTRO_SEC).toFixed(5) + '%';

    $('outroSlot').style.right = '0%';
    $('outroSlot').style.width = pct(OUTRO_SEC).toFixed(5) + '%';

    $('reviewSlot').style.right = pct(OUTRO_SEC).toFixed(5) + '%';
    $('reviewSlot').style.width = pct(REVIEW_SEC).toFixed(5) + '%';

    if(totalParagraphs <= 0){
      $('elapsed').style.width = '0%';
      $('cursor').style.left = '0%';
      return;
    }

    for(let i=1;i<=totalParagraphs;i++){
      const startSec = cumulative[i-1];
      const leftP = pct(startSec);

      const tick = document.createElement('div');
      tick.className = 'tick';
      tick.style.left = leftP + '%';

      const lbl = document.createElement('div');
      lbl.className = 'tick-label ' + (i % 2 === 1 ? 'odd' : 'even');
      lbl.textContent = i;
      lbl.style.left = leftP + '%';

      t.appendChild(tick);
      t.appendChild(lbl);
    }

    $('elapsed').style.width = '0%';
    $('cursor').style.left = '0%';
  }

  // --- Klokke / meldinger ---
  function resetClockUI(){
    if (tickHandle) clearInterval(tickHandle);
    started = false;
    $('clock').textContent = '00:00';
    $('clock').classList.remove('over');
  }

  function startClock(){
    startTs = Date.now();
    if (tickHandle) clearInterval(tickHandle);
    tickHandle = setInterval(tick, 250);
  }
  function stopClock(){
    if (tickHandle) clearInterval(tickHandle);
    tickHandle = null;
  }

  function setMessage(msg){
    if (msg !== lastMilestone){
      $('message').textContent = msg;
      lastMilestone = msg;
    }
  }

  function tick(){
    const elapsed = Math.floor((Date.now() - startTs)/1000);
    $('clock').textContent = fmt(elapsed);
    if(elapsed >= TOTAL_SEC) $('clock').classList.add('over'); else $('clock').classList.remove('over');

    const p = Math.min((elapsed / TOTAL_SEC) * 100, 100);
    $('elapsed').style.width = p + '%';
    $('cursor').style.left = `calc(${p}% - 1.5px)`;

    if (elapsed < INTRO_SEC){
      setMessage('Introduksjon');
    } else if (elapsed >= TOTAL_SEC){
      setMessage('Du er over tiden');
    } else if (elapsed >= TOTAL_SEC - OUTRO_SEC){
      setMessage('Avslutning');
    } else if (elapsed >= TOTAL_SEC - OUTRO_SEC - REVIEW_SEC){
      setMessage('Repetisjonsspørsmål');
    } else {
      let idx = 0;
      for (let i=0;i<totalParagraphs;i++){
        const start = cumulative[i];
        const end = (i === totalParagraphs-1) ? (TOTAL_SEC - OUTRO_SEC - REVIEW_SEC) : cumulative[i+1];
        if (elapsed >= start && elapsed < end){ idx = i; break; }
      }
      let msg = `Avsnitt ${idx+1}`;
      if (elapsed >= 1800 && elapsed < 1860){ msg += ' — Halvveis i studiet!'; }
      setMessage(msg);
    }
  }

  function fmt(s){ return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }

  function updateInfoLine(resetGhost){
    $('editParagraphs').value = Math.max(1, totalParagraphs|0);
    $('editQuestions').value  = Math.max(0, questions|0);
    $('editScriptures').value = Math.max(0, scriptures|0);

    if (resetGhost){
      $('editParagraphs').classList.add('ghost');
      $('editQuestions').classList.add('ghost');
      $('editScriptures').classList.add('ghost');
    }

    $('adjustBtn').disabled = !(totalParagraphs > 0);
  }

  // Init-tekst
  setMessage('Begynn med å lime inn artikkelserien og analysere den.');
</script>
</body>
</html>
