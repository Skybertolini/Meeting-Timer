<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Meeting Timer</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f7f8fa">

<style>
:root{
  --bg-top:#f7f8fa; --bg-bot:#eef1f4; --text:#0f1b2b;
  --card: rgba(255,255,255,.82);
  --border: rgba(0,0,0,.06);
  --muted:#8a94a1;
  --accent:#0d6efd;
  --green:#28a745; --orange:#ff9800; --red:#d21f3c; --ink:#0f1b2b;
  --radius:16px;
}
html,body{
  font-family: ui-rounded, -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  letter-spacing:.01em;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.h1{ font-weight:900; }
.pill, .select{ font-weight:800; }
.segmented button{ font-weight:800; }
  
/* Apple 2025-ish type stack */
*{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
html,body{
  margin:0; padding:0; color:var(--text);
  background:linear-gradient(180deg,var(--bg-top) 0%, var(--bg-bot) 100%);
  font-family: ui-rounded, -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  letter-spacing:.01em;
}
.container{ max-width:980px; margin:0 auto; padding:16px 16px 28px; }

/* Topbar */
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 0 12px;
}
.brand{
  display:flex; align-items:center; gap:14px;
}
/* — Logo størrelsen — */
.brand img{
  height:180px;       /* ~3× større */
  width:auto;
  filter: drop-shadow(0 12px 30px rgba(0,0,0,.10));
}
@media (min-width: 768px){
  .brand img{ height:216px; } /* litt større på iPad */
}

/* — Mer luft under topplinja til info-båndet — */
.topbar{ padding:8px 0 22px; }

/* — Info-bånd → tittel/melding — */
.h1{ margin:20px 0 10px; }
.message{ margin-bottom:14px; }

/* — Ekstra luft ned til tidslinja — */
.timeline-wrap{ margin-top:26px; }
}

/* Cupertino segmented control */
.segmented{
  display:inline-flex; background:var(--card); border:1px solid var(--border);
  border-radius:999px; padding:4px; gap:4px; box-shadow:0 8px 30px rgba(0,0,0,.06);
}
.segmented button{
  border:0; background:transparent; padding:10px 16px; border-radius:999px;
  font-weight:800; color:var(--ink); cursor:pointer;
}
.segmented button.active{
  background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.08);
}

/* Card */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:0 12px 40px rgba(0,0,0,.06);
  padding:14px;
}

/* Info band */
.infoband{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
}
.pill{
  background:#fff; border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-weight:800;
  box-shadow:0 4px 16px rgba(0,0,0,.05);
}
.select{
  appearance:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff; font-weight:800;
  box-shadow:0 4px 16px rgba(0,0,0,.05); min-width:220px;
}

/* Title + message */
.h1{
  font-size:1.3rem; font-weight:900; margin:12px 0 6px;
}
.message{
  background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px 14px; min-height:1.2em;
  color:#0c2915; box-shadow:0 8px 24px rgba(0,0,0,.06);
}

/* Timeline */
.timeline-wrap{ margin-top:16px }
.timeline{
  position:relative; height:56px; border-radius:14px; overflow:visible;
  background:linear-gradient(180deg,#f3fbf6 0%, #eaf6ec 100%);
  border:1px solid var(--border);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.85), 0 12px 36px rgba(0,0,0,.06);
}
.slot{ position:absolute; top:0; height:100%; opacity:.25 }
.para-slot{
  position:absolute; top:0; height:100%; display:flex; align-items:center; justify-content:center;
  border-left:1px solid rgba(0,0,0,.04); border-right:1px solid rgba(255,255,255,.45);
  font-weight:900; color:#134e2f; text-shadow:0 1px 0 rgba(255,255,255,.6);
  cursor:pointer; box-sizing:border-box; min-width:28px;
}
.para-slot > div{ pointer-events:none; white-space:nowrap; overflow:hidden; text-overflow:clip; line-height:1; }
.elapsed{ position:absolute; top:0; left:0; height:100%; background:rgba(255,77,64,.25); width:0%; transition:width .25s linear; z-index:2 }
.cursor { position:absolute; top:-10px; width:2px; height:76px; background:linear-gradient(#e3262e,#b4141a); left:0%; z-index:3; box-shadow:0 0 0 2px rgba(227,38,46,.12) }

.big-clock, .clock{
  margin-top:18px; font-size:2.2rem; font-weight:900; color:#1e824c; text-shadow:0 1px 0 #fff;
}
.over{ color:#c41111 !important; text-shadow:none; }

/* Controls */
.controls{
  display:flex; gap:12px; margin-top:14px;
}
.round{
  width:58px; height:58px; border-radius:999px; border:0; cursor:pointer;
  display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.5rem;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
.play{ background:var(--green) }
.pause{ background:#f0ad4e }
.stop{ background:var(--red) }
.rewind{ background:#6c757d }
.round:disabled{ background:#aab2bd; cursor:not-allowed; box-shadow:none }

.view{ display:none }
.view.active{ display:block }

/* Annet (countdown) */
.center{ text-align:center }
.preset-row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
.preset{
  border:1px solid var(--border); background:var(--card); border-radius:999px; padding:10px 14px; font-weight:900; cursor:pointer;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
.preset.active{ background:#fff }

.picker{
  margin-top:10px; display:flex; gap:16px; justify-content:center; align-items:center;
}
.stepper{
  display:flex; flex-direction:column; align-items:center; gap:8px; background:var(--card);
  border:1px solid var(--border); border-radius:14px; padding:10px 12px; min-width:92px; box-shadow:0 8px 24px rgba(0,0,0,.06)
}
.stepper .value{ font-size:2rem; font-weight:900; min-width:64px; }
.stepper button{ border:0; border-radius:10px; padding:6px 10px; font-weight:800; background:#fff; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.06) }
.sep{ font-size:2rem; font-weight:900; opacity:.55 }

/* Footer */
.footer{ text-align:center; color:#8f96a3; font-size:.9rem; margin-top:22px }
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <img src="meeting-timer-logo.png" alt="Meeting Timer logo" />
      <div class="title">Meeting Timer</div>
    </div>

    <div class="segmented" role="tablist" aria-label="Modus">
      <button id="tabWT" class="active" role="tab" aria-selected="true">Vakttårnstudiet</button>
      <button id="tabSP" role="tab" aria-selected="false">Annet</button>
    </div>
  </div>

  <!-- VIEW: Vakttårnstudiet -->
  <div id="viewWT" class="view active">
    <div class="card infoband" style="justify-content:space-between; gap:12px">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <select id="langSel" class="select" aria-label="Språk">
          <option value="no">Norsk</option>
          <option value="sv">Svenska</option>
        </select>
        <select id="weekSel" class="select" aria-label="Uke (mandag)">
          <option>Laster …</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <div class="pill" id="pillParas">0 avsnitt</div>
        <div class="pill" id="pillQ">0 spørsmål</div>
        <div class="pill" id="pillReads">0 Les/Läs</div>
      </div>
    </div>

    <div class="h1" id="articleTitle">—</div>
    <div class="message" id="message">Velg språk og uke for å laste artikkel.</div>

    <div class="timeline-wrap">
      <div id="timeline" class="timeline">
        <div id="introSlot" class="slot" style="left:0%;width:0;background:#0d6efd"></div>
        <div id="reviewSlot" class="slot" style="right:0;width:0;background:#ff8800"></div>
        <div id="outroSlot" class="slot" style="right:0;width:0;background:#0d6efd"></div>
        <div id="elapsed" class="elapsed"></div>
        <div id="cursor" class="cursor"></div>
      </div>
      <div class="clock" id="clockWT">00:00</div>
    </div>

    <div class="controls">
      <button id="playWT"  class="round play"  title="Start/Gjenoppta" aria-label="Start">▶</button>
      <button id="pauseWT" class="round pause" title="Pause" aria-label="Pause" disabled>❚❚</button>
      <button id="stopWT"  class="round stop"  title="Stopp" aria-label="Stopp" disabled>■</button>
    </div>
  </div>

  <!-- VIEW: Annet (nedtelling) -->
  <div id="viewSP" class="view">
    <div class="card center">
      <div class="preset-row">
        <button class="preset" data-sec="600">10:00</button>
        <button class="preset" data-sec="480">08:00</button>
        <button class="preset" data-sec="300">05:00</button>
      </div>

      <div class="picker">
        <div class="stepper">
          <button id="minUp">▲</button>
          <div id="minVal" class="value">10</div>
          <button id="minDown">▼</button>
        </div>
        <div class="sep">:</div>
        <div class="stepper">
          <button id="secUp">▲</button>
          <div id="secVal" class="value">00</div>
          <button id="secDown">▼</button>
        </div>
      </div>

      <div id="clockSP" class="big-clock">10:00</div>
      <div id="msgSP" class="message" style="margin-inline:auto; max-width:520px">Klar til nedtelling.</div>

      <div class="controls" style="justify-content:center">
        <button id="playSP"  class="round play"  title="Start/Gjenoppta" aria-label="Start">▶</button>
        <button id="pauseSP" class="round pause" title="Pause" aria-label="Pause" disabled>❚❚</button>
        <button id="stopSP"  class="round stop"  title="Stopp/Nullstill" aria-label="Stopp" disabled>■</button>
      </div>
    </div>
  </div>

  <div class="footer">Meeting Timer © 2025</div>
</div>

<script>
/* ===========================
   Konstanter / helpers
   =========================== */
const TOTAL = 3600, INTRO=90, REVIEW=120, OUTRO=90, CONTENT=TOTAL-INTRO-REVIEW-OUTRO;
const WPM=150, SEC_PER_Q=10, SEC_PER_READ=30, AB_BONUS=30;
const $=sel=>document.querySelector(sel);
const pct = sec => (sec/TOTAL)*100;
const fmt = s => {s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0');};

function isoMonday(d=new Date()){
  const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const w=(x.getUTCDay()+6)%7; x.setUTCDate(x.getUTCDate()-w); return x.toISOString().slice(0,10);
}
function addDaysISO(iso,days){ const d=new Date(iso); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }

/* ===========================
   Tilstand – WT
   =========================== */
let lang='no';
let paras=[], perParagraph=[], cumulative=[], totalParagraphs=0, questions=0, reads=0;
let started=false, paused=false, startTs=null, accum=0, tickHandle=null;

/* ===========================
   Last data (JSON) – prøv data/ og Data/
   =========================== */
async function fetchJSON(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Fetch feilet: '+url);
  return await res.json();
}
async function loadYear(lang, year){
  const tries = [
    `data/${lang}-${year}.json`,
    `Data/${lang}-${year}.json`
  ];
  const errors=[];
  for(const u of tries){
    try{ return await fetchJSON(`${u}?v=${Date.now().toString().slice(7)}`); }
    catch(e){ errors.push(String(e)); }
  }
  throw new Error(errors.join(' | '));
}

async function hydrateOptions(){
  const today = new Date();
  const year = today.getFullYear();
  let items = [];
  try{
    const payloads = [];
    for(const y of [year, year+1]){
      try{ payloads.push(await loadYear(lang, y)); }catch(e){}
    }
    items = payloads.flatMap(p => p?.items||[]);
  }catch(e){
    console.warn('Kunne ikke laste årsfil(er):', e);
  }

  const sel = $('#weekSel');
  sel.innerHTML='';

  if(!items.length){
    const opt=document.createElement('option');
    opt.textContent='Fant ingen datafiler (sjekk /data eller /Data i repoet).';
    opt.disabled=true; opt.selected=true;
    sel.appendChild(opt);
    $('#message').textContent='Ingen data lastet. Sjekk at filene heter data/no-2025.json eller Data/no-2025.json.';
    return;
  }

  const start = isoMonday(today);
  const targets = [0,7,14].map(x=>addDaysISO(start,x));
  const options = items.filter(it=>targets.includes(it.week_start))
                       .sort((a,b)=>a.week_start.localeCompare(b.week_start));

  if(options.length===0){
    const opt=document.createElement('option');
    const have = [...new Set(items.map(i=>i.week_start))].slice(0,6).join(', ');
    opt.textContent = `Ingen treff for ${targets.join(', ')}. Tilgjengelige: ${have||'–'}`;
    opt.disabled=true; opt.selected=true;
    sel.appendChild(opt);
    $('#message').textContent='Fant ingen ukesobjekter for inneværende uke + 2 fram. Sjekk week_start-datoene.';
    return;
  }

  options.forEach(it=>{
    const o=document.createElement('option');
    o.value = JSON.stringify(it);
    o.textContent = `${it.week_start} – ${it.title || '(uten tittel)'}`;
    sel.appendChild(o);
  });
  sel.selectedIndex=0;
  useItem(JSON.parse(sel.value));
}

function useItem(item){
  $('#articleTitle').textContent = item.title || '—';
  totalParagraphs = item.paragraphs|0;
  questions = item.questions|0;
  reads = item.reads|0;
  paras = (item.words||[]).map((w,i)=>({num:i+1, words:w|0, q:1, les:0, hasAB:false}));
  if(paras.length!==totalParagraphs){
    paras = Array.from({length: totalParagraphs}, (_,i)=>({num:i+1, words:0, q:1, les:0, hasAB:false}));
  }
  $('#pillParas').textContent = `${totalParagraphs} avsnitt`;
  $('#pillQ').textContent     = `${questions} spørsmål`;
  $('#pillReads').textContent = `${reads} ${lang==='sv'?'Läs':'Les'}`;

  computeAllocation(); drawTimeline(); resetClockUI();
  $('#message').textContent='Klar til start. Trykk ▶ når du er klar.';
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true;
}

/* ===========================
   Fordeling & timeline
   =========================== */
function computeAllocation(){
  if(totalParagraphs<=0){ perParagraph=[]; cumulative=[]; return; }
  const wps=WPM/60;
  const raw = Array.from({length: totalParagraphs}, (_,i)=>{
    const p = paras[i] || {words:0,q:1,les:0,hasAB:false};
    let sec = (p.words||0)/wps + (p.q||0)*SEC_PER_Q + (p.les||0)*SEC_PER_READ + (p.hasAB?AB_BONUS:0);
    return Math.max(5, sec);
  });
  const sum = raw.reduce((a,b)=>a+b,0)||1;
  const scale = CONTENT/sum;
  perParagraph = raw.map(x=>x*scale);
  cumulative=[]; let acc=INTRO;
  for(let i=0;i<totalParagraphs;i++){ cumulative.push(acc); acc+=perParagraph[i]; }
}
function hexToRgb(h){const s=h.replace('#','');const n=s.length===3?s.split('').map(x=>x+x).join(''):s;return{r:parseInt(n.slice(0,2),16),g:parseInt(n.slice(2,4),16),b:parseInt(n.slice(4,6),16)}}
function lerpColor(h1,h2,t){const a=hexToRgb(h1),b=hexToRgb(h2);const r=Math.round(a.r+(b.r-a.r)*t),g=Math.round(a.g+(b.g-a.g)*t),bl=Math.round(a.b+(b.b-a.b)*t);return`rgb(${r}, ${g}, ${bl})`}

function drawTimeline(){
  const t = $('#timeline');
  Array.from(t.querySelectorAll('.para-slot')).forEach(n=>n.remove());

  $('#introSlot').style.left='0%'; $('#introSlot').style.width=pct(INTRO).toFixed(4)+'%';
  $('#outroSlot').style.right='0%'; $('#outroSlot').style.width=pct(OUTRO).toFixed(4)+'%';
  $('#reviewSlot').style.right=pct(OUTRO).toFixed(4)+'%'; $('#reviewSlot').style.width=pct(REVIEW).toFixed(4)+'%';

  if(totalParagraphs<=0){ $('#elapsed').style.width='0%'; $('#cursor').style.left='0%'; return; }

  const timelinePx = t.clientWidth;
  const startCol='#e8f6ee', endCol='#bfe3ce';
  const LABEL_MIN_1 = 18, LABEL_MIN_2 = 26, SHRINK_AT = 34;

  for(let i=1;i<=totalParagraphs;i++){
    const leftP = pct(cumulative[i-1]);
    const widthP= pct(perParagraph[i-1]);
    const widthPx = (perParagraph[i-1]/TOTAL)*timelinePx;

    const slot=document.createElement('div');
    slot.className='para-slot';
    slot.style.left=leftP+'%';
    slot.style.width=widthP+'%';

    const tN=(i-1)/Math.max(1,(totalParagraphs-1));
    slot.style.background=lerpColor(startCol,endCol,tN);

    const lbl=document.createElement('div');
    const need = i>=10 ? LABEL_MIN_2 : LABEL_MIN_1;
    if(widthPx >= need){
      lbl.textContent = String(i);
      lbl.style.fontSize = (widthPx<SHRINK_AT?'.72rem':'.82rem');
    }else{
      lbl.textContent = '';
    }
    slot.appendChild(lbl);

    slot.addEventListener('click', ()=>{
      if(started && !paused) return;
      const target = cumulative[i-1];
      accum = Math.min(Math.round(target), TOTAL-OUTRO-REVIEW);
      const pNow = Math.min(accum/TOTAL*100,100);
      $('#elapsed').style.width=pNow+'%';
      $('#cursor').style.left=`calc(${pNow}% - 1px)`;
      $('#clockWT').textContent = fmt(accum);
      $('#clockWT').classList.toggle('over', accum>=TOTAL);
      $('#message').textContent = `Avsnitt ${i}`;
    });

    t.insertBefore(slot, $('#elapsed'));
  }
  $('#elapsed').style.width='0%'; $('#cursor').style.left='0%';
}
let _rAF=null;
window.addEventListener('resize', ()=>{ if(_rAF) cancelAnimationFrame(_rAF); _rAF=requestAnimationFrame(()=>{ if(totalParagraphs>0) drawTimeline(); }); });

/* ===========================
   Klokke – WT
   =========================== */
function resetClockUI(){ if(tickHandle)clearInterval(tickHandle); $('#clockWT').textContent='00:00'; $('#clockWT').classList.remove('over'); }
function startClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=setInterval(tickWT,250); }
function stopClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=null; }
function nowElapsed(){ if(!started) return accum; if(paused) return accum; const live=Math.floor((Date.now()-startTs)/1000); return accum+live; }

function tickWT(){
  const e = nowElapsed();
  $('#clockWT').textContent = fmt(e);
  $('#clockWT').classList.toggle('over', e>=TOTAL);
  const p = Math.min(e/TOTAL*100,100);
  $('#elapsed').style.width=p+'%';
  $('#cursor').style.left=`calc(${p}% - 1px)`;

  if(e < INTRO) { $('#message').textContent='Introduksjon'; }
  else if(e >= TOTAL) { $('#message').textContent='Tiden er brukt – teller over'; }
  else if(e >= TOTAL-OUTRO) { $('#message').textContent='Avslutning'; }
  else if(e >= TOTAL-OUTRO-REVIEW) { $('#message').textContent='Repetisjonsspørsmål'; }
  else {
    let idx=0;
    for(let i=0;i<totalParagraphs;i++){
      const s=cumulative[i], end=(i===totalParagraphs-1)?(TOTAL-OUTRO-REVIEW):cumulative[i+1];
      if(e>=s && e<end){ idx=i; break; }
    }
    let msg=`Avsnitt ${idx+1}`;
    if(e>=1800 && e<1860) msg+=' – du er halvveis';
    $('#message').textContent=msg;
  }
}

/* WT kontroller */
$('#playWT').addEventListener('click', ()=>{
  if(started && paused){
    paused=false; startTs=Date.now(); startClock();
    $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false;
    return;
  }
  if(!started){
    started=true; paused=false; startTs=Date.now(); startClock();
    $('#message').textContent='Introduksjon';
    $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false;
  }
});
$('#pauseWT').addEventListener('click', ()=>{
  if(!started || paused) return;
  accum += Math.floor((Date.now()-startTs)/1000); paused=true; stopClock();
  $('#message').textContent='Pause';
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=false;
});
$('#stopWT').addEventListener('click', ()=>{
  if(started && !paused) accum += Math.floor((Date.now()-startTs)/1000);
  started=false; paused=false; stopClock();
  $('#message').textContent=`Ferdig – totalt ${fmt(accum)}`;
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true;
  accum=0; resetClockUI();
  $('#elapsed').style.width='0%'; $('#cursor').style.left='0%';
});

/* ===========================
   FANER
   =========================== */
const views = { WT: $('#viewWT'), SP: $('#viewSP') };
const tabs  = { WT: $('#tabWT'), SP: $('#tabSP') };
function activateView(key){
  Object.entries(views).forEach(([k,el])=>el.classList.toggle('active', k===key));
  Object.entries(tabs).forEach(([k,btn])=>{
    btn.classList.toggle('active', k===key);
    btn.setAttribute('aria-selected', k===key?'true':'false');
  });
}
$('#tabWT').addEventListener('click', ()=>activateView('WT'));
$('#tabSP').addEventListener('click', ()=>activateView('SP'));

/* ===========================
   Språk + uke
   =========================== */
$('#langSel').addEventListener('change', async ()=>{
  lang = $('#langSel').value || 'no';
  await hydrateOptions();
  localStorage.setItem('meetingTimer.lang', lang);
});
$('#weekSel').addEventListener('change', ()=>{
  const val = $('#weekSel').value;
  if(!val) return;
  useItem(JSON.parse(val));
});

/* ===========================
   ANNET – nedtelling
   =========================== */
const PRESET_KEY='meetingTimer.annetSeconds';
const presets = Array.from(document.querySelectorAll('.preset-row .preset'));
let spRunning=false, spPaused=false, spStart=null, spAccum=0, spTick=null;
let SP_TOTAL = parseInt(localStorage.getItem(PRESET_KEY),10) || 600;

// meldingsflagg
let showStart=false, shownHalf=false, shownOneMin=false, shownOver=false;

function spFmt(s){ s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }
function spElapsed(){ if(!spRunning) return spAccum; if(spPaused) return spAccum; const live=Math.floor((Date.now()-spStart)/1000); return spAccum+live; }

function markPreset(sec){ spPresets.forEach(b=>b.classList.toggle('active', parseInt(b.dataset.sec,10)===sec)); }

function setStep(min, sec){
  min=Math.max(0,Math.min(999,min|0)); sec=Math.max(0,Math.min(59,sec|0));
  $('#minVal').textContent=String(min);
  $('#secVal').textContent=String(sec).padStart(2,'0');
  if(!spRunning){
    SP_TOTAL = min*60+sec;
    $('#clockSP').textContent=spFmt(SP_TOTAL);
    markPreset([600,480,300].includes(SP_TOTAL)?SP_TOTAL:-1);
    localStorage.setItem(PRESET_KEY, String(SP_TOTAL));
  }
}

function resetFlags(){ showStart=false; shownHalf=false; shownOneMin=false; shownOver=false; }
function interpColor(t){ const a=[0x1e,0x82,0x4c], b=[0xf0,0xad,0x4e]; const mix=i=>Math.round(a[i]+(b[i]-a[i])*(1-t)); return `rgb(${mix(0)}, ${mix(1)}, ${mix(2)})`; }

function updateSP(){
  const e=spElapsed();
  const remain = SP_TOTAL - e;
  const clock = $('#clockSP');

  if(spRunning && !spPaused){
    if(e<=10 && !showStart){ $('#msgSP').textContent='Vi er i gang'; showStart=true; }
    if(e>=Math.floor(SP_TOTAL/2) && !shownHalf){ $('#msgSP').textContent='Du er halvveis'; shownHalf=true; }
    if(remain===60 && !shownOneMin){ $('#msgSP').textContent='1 minutt igjen!'; shownOneMin=true; }
    if(remain<0 && !shownOver){ $('#msgSP').textContent='Du har gått over tiden!'; shownOver=true; }
  }else{
    $('#msgSP').textContent='Klar til nedtelling.';
  }

  if(remain>=0){
    clock.classList.remove('over');
    clock.textContent = spFmt(remain);
    clock.style.color = remain>60 ? '' : interpColor(Math.max(0,remain)/60);
  }else{
    clock.classList.add('over');
    clock.style.color = '';
    clock.textContent = spFmt(-remain);
  }
}
function spStart(){
  if(spRunning && spPaused){
    spPaused=false; spStart=Date.now(); spTick && clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false;
    return;
  }
  if(!spRunning){
    spRunning=true; spPaused=false; spStart=Date.now(); spAccum=0; resetFlags();
    spTick && clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false;
    updateSP();
  }
}
function spPause(){
  if(!spRunning || spPaused) return;
  spAccum += Math.floor((Date.now()-spStart)/1000);
  spPaused=true; spTick && clearInterval(spTick); spTick=null;
  $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=false;
  updateSP();
}
function spStop(){
  if(spRunning && !spPaused) spAccum += Math.floor((Date.now()-spStart)/1000);
  spRunning=false; spPaused=false; spStart=null; spAccum=0;
  spTick && clearInterval(spTick); spTick=null;
  $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=true;
  $('#clockSP').classList.remove('over'); $('#clockSP').style.color='';
  $('#msgSP').textContent='Klar til nedtelling.';
  const s = parseInt(localStorage.getItem(PRESET_KEY),10) || 600;
  setStep(Math.floor(s/60), s%60);
  $('#clockSP').textContent=spFmt(s);
}
$('#playSP').addEventListener('click', spStart);
$('#pauseSP').addEventListener('click', spPause);
$('#stopSP').addEventListener('click', spStop);

const spPresets = Array.from(document.querySelectorAll('.preset-row .preset'));
spPresets.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(spRunning) return;
    const s=parseInt(btn.dataset.sec,10)||600;
    localStorage.setItem(PRESET_KEY, String(s));
    markPreset(s);
    setStep(Math.floor(s/60), s%60);
    $('#clockSP').textContent=spFmt(s);
    $('#msgSP').textContent='Klar til nedtelling.';
  });
});
$('#minUp').addEventListener('click', ()=>{ if(spRunning) return; const m=parseInt(minVal.textContent,10)||0; setStep(m+1, parseInt(secVal.textContent,10)||0); });
$('#minDown').addEventListener('click', ()=>{ if(spRunning) return; const m=parseInt(minVal.textContent,10)||0; setStep(m-1, parseInt(secVal.textContent,10)||0); });
$('#secUp').addEventListener('click', ()=>{ if(spRunning) return; let s=(parseInt(secVal.textContent,10)||0)+1; let m=parseInt(minVal.textContent,10)||0; if(s>=60){ m++; s=0; } setStep(m,s); });
$('#secDown').addEventListener('click', ()=>{ if(spRunning) return; let s=(parseInt(secVal.textContent,10)||0)-1; let m=parseInt(minVal.textContent,10)||0; if(s<0){ if(m>0){ m--; s=59; } else { s=0; } } setStep(m,s); });

/* ===========================
   INIT
   =========================== */
(async function init(){
  const savedLang = localStorage.getItem('meetingTimer.lang');
  if(savedLang) $('#langSel').value = savedLang;
  lang = $('#langSel').value || 'no';

  // Annet – gjenopprett siste preset
  const s = parseInt(localStorage.getItem(PRESET_KEY),10) || 600;
  markPreset([600,480,300].includes(s)?s:-1);
  setStep(Math.floor(s/60), s%60);
  $('#clockSP').textContent=spFmt(s);

  await hydrateOptions();
})();
</script>
</body>
</html>
