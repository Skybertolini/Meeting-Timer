<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Meeting Timer</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f7f8fa">

<style>
:root{
  /* Papiraktige farger */
  --paper-bg-top:#f4f1e9;
  --paper-bg-bot:#eae6dd;
  --text:#3a2f2b;
  --card-bg:#fdfbf7;
  --card-border:rgba(0,0,0,.08);

  /* Dempa knappefarger */
  --green:#3b7d4f;
  --orange:#d9913c;
  --red:#b94a48;
  --gray:#7d7d7d;

  --muted:#9a9186;
  --radius:14px;
}
html,body{
  font-family: ui-rounded, -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background:linear-gradient(180deg,var(--paper-bg-top) 0%,var(--paper-bg-bot) 100%);
  color:var(--text); margin:0; padding:24px; display:flex; flex-direction:column; align-items:center;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.container{ width:min(960px,94vw); max-width:880px }

/* Topplinje */
.topbar{ width:100%; display:flex; justify-content:space-between; align-items:center; margin:-8px 0 20px; gap:12px }
.left-group{ display:flex; align-items:center; gap:12px }
.logo-box img{ max-height:180px; width:auto; }

/* Inputs */
textarea{
  width:100%; height:180px; resize:vertical; padding:12px; font-size:1rem;
  border:1px solid var(--card-border); border-radius:var(--radius);
  background:var(--card-bg); color:inherit;
}
textarea:focus{ outline:none; border-color:rgba(46,170,220,.55); box-shadow:0 0 0 4px rgba(46,170,220,.18) }

/* Info-linje */
.info-line{ display:flex; flex-wrap:wrap; align-items:center; gap:14px; margin-top:16px; margin-bottom:20px }
.inline-edit{
  display:inline-flex; align-items:center; gap:8px; background:var(--card-bg);
  border:1px solid var(--card-border); border-radius:999px; padding:8px 10px;
}
.inline-edit label{ font-size:.95rem }
.inline-edit input{ width:90px; padding:6px 8px; font-size:1rem; border:1px solid #cfc9c2; border-radius:8px; background:#fffefc; color:#333 }

/* Tittel + melding */
.title{ font-size:1.4rem; font-weight:800; margin-top:14px; margin-bottom:12px }
.message-box{
  margin-top:10px; padding:14px 18px; background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius); font-size:1.05rem; color:var(--text);
  min-height:1.2em; text-align:center;
}

/* Timeline */
.timeline-wrap{ width:100%; margin-top:28px; margin-bottom:20px }
.timeline{
  position:relative; height:52px; border-radius:var(--radius);
  background:linear-gradient(180deg,#f8f6f0 0%,#ece9e2 100%);
  border:1px solid rgba(0,0,0,.08);
  overflow:visible;
}
.slot{ position:absolute; top:0; height:100%; opacity:.25 }
.para-slot{
  position:absolute; top:0; height:100%;
  display:flex; align-items:center; justify-content:center;
  border-left:1px solid rgba(0,0,0,.04); border-right:1px solid rgba(255,255,255,.45);
  font-size:.8rem; font-weight:700; color:#3a2f2b;
  cursor:pointer;
}
.elapsed{ position:absolute; top:0; left:0; height:100%; background:rgba(185,74,72,.25); width:0%; transition:width .25s linear; z-index:2 }
.cursor{ position:absolute; top:-10px; width:2px; height:72px; background:#b94a48; left:0%; z-index:3 }

#clock{ margin-top:12px; font-size:2.1rem; font-weight:800; color:var(--green); }

/* Kontroller */
.footer{ margin-top:22px; width:100%; display:flex; gap:14px; justify-content:center }
.round-btn{ display:inline-flex; align-items:center; justify-content:center; width:56px; height:56px; border-radius:999px; border:0; cursor:pointer }
.play-btn{ background:var(--green) } .play-btn::before{ content:"▶"; color:#fff; font-size:1.5rem; margin-left:3px }
.pause-btn{ background:var(--orange) } .pause-btn::before{ content:"❚❚"; color:#fff; font-size:1.2rem }
.stop-btn{ background:var(--red) } .stop-btn::before{ content:""; display:block; width:16px; height:16px; background:#fff; border-radius:2px }

/* Presets (annet-fanen) */
.preset-row{ display:flex; justify-content:center; gap:10px; margin:20px 0 }
.preset{
  background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px;
  padding:10px 16px; cursor:pointer; font-weight:700; font-size:1rem;
}
.preset.active{ background:var(--green); color:#fff; }

/* Milestone images */
.milestone-img{
  max-width:40%;
  height:auto;
  margin:12px auto;
  display:block;
  background:none;
  padding:0;
  border:none;
  box-shadow:none;
}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="left-group">
      <div class="logo-box">
        <img src="meeting-timer-logo.png" alt="Meeting Timer logo">
      </div>
    </div>
    <select id="langSelect" class="lang-select" aria-label="Language">
      <option value="no">Norsk</option>
      <option value="sv">Svenska</option>
    </select>
  </div>
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <img src="meeting-timer-logo.png" alt="Meeting Timer" />
    </div>

    <div class="segmented" role="tablist" aria-label="Modus">
      <button id="tabWT" class="active" role="tab" aria-selected="true">Vakttårnstudiet</button>
      <button id="tabSP" role="tab" aria-selected="false">Annet</button>
    </div>
  </div>

  <!-- Banner-plass (vises på Annet ved 30/10 min) -->
  <div id="spBanner" class="sp-banner" hidden>
    <img id="spBannerImg" alt="" />
  </div>

  <!-- VIEW: Vakttårnstudiet -->
  <div id="viewWT" class="view active">
    <div class="card infoband" style="justify-content:space-between; gap:10px">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <select id="langSel" class="select" aria-label="Språk">
          <option value="no">Norsk</option>
          <option value="sv">Svenska</option>
        </select>
        <select id="weekSel" class="select" aria-label="Uke (mandag)">
          <option>Laster …</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <div class="pill" id="pillParas">Avsnitt: 0</div>
        <div class="pill" id="pillQ">Spørsmål: 0</div>
        <div class="pill" id="pillReads">Les-skriftsteder: 0</div>
      </div>
    </div>

    <div class="h1" id="articleTitle">—</div>
    <div class="message" id="message">Velg språk og uke for å laste artikkel.</div>

    <div class="timeline-wrap">
      <div id="timeline" class="timeline">
        <div id="introSlot" class="slot" style="left:0%;width:0;background:#0d6efd"></div>
        <div id="reviewSlot" class="slot" style="right:0;width:0;background:#ff8800"></div>
        <div id="outroSlot" class="slot" style="right:0;width:0;background:#0d6efd"></div>
        <div id="elapsed" class="elapsed"></div>
        <div id="cursor" class="cursor"></div>
      </div>
      <div class="clock" id="clockWT">00:00</div>
    </div>

    <div class="controls">
      <button id="playWT"  class="round play"  title="Start/Gjenoppta" aria-label="Start">▶</button>
      <button id="pauseWT" class="round pause" title="Pause" aria-label="Pause" disabled>❚❚</button>
      <button id="stopWT"  class="round stop"  title="Stopp" aria-label="Stopp" disabled>■</button>
    </div>
  </div>

  <!-- VIEW: Annet (nedtelling) -->
  <div id="viewSP" class="view">
    <div class="card center">
      <div class="preset-row">
        <button class="preset" data-sec="1800">30:00</button>
        <button class="preset" data-sec="900">15:00</button>
        <button class="preset" data-sec="600">10:00</button>
        <button class="preset" data-sec="300">05:00</button>
      </div>

      <div class="picker">
        <div class="stepper">
          <button id="minUp">▲</button>
          <div id="minVal" class="value">10</div>
          <button id="minDown">▼</button>
        </div>
        <div class="sep">:</div>
        <div class="stepper">
          <button id="secUp">▲</button>
          <div id="secVal" class="value">00</div>
          <button id="secDown">▼</button>
        </div>
      </div>

      <div id="clockSP" class="big-clock">10:00</div>
      <div id="msgSP" class="message" style="margin-inline:auto; max-width:520px">Klar til nedtelling.</div>

      <div class="controls" style="justify-content:center">
        <button id="playSP"  class="round play"  title="Start/Gjenoppta" aria-label="Start">▶</button>
        <button id="pauseSP" class="round pause" title="Pause" aria-label="Pause" disabled>❚❚</button>
        <button id="stopSP"  class="round stop"  title="Stopp/Nullstill" aria-label="Stopp" disabled>■</button>
      </div>
    </div>
  </div>

  <div class="footer">Meeting Timer © 2025</div>
</div>

<script>
/* ===========================
   Helpers / konstanter
   =========================== */
const TOTAL = 3600, INTRO=90, REVIEW=120, OUTRO=90, CONTENT=TOTAL-INTRO-REVIEW-OUTRO;
const WPM=150, SEC_PER_Q=10, SEC_PER_READ=30, AB_BONUS=30;
const $=sel=>document.querySelector(sel);
const pct = sec => (sec/TOTAL)*100;
const fmt = s => {s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0');};

function isoMonday(d=new Date()){
  const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const w=(x.getUTCDay()+6)%7; x.setUTCDate(x.getUTCDate()-w); return x.toISOString().slice(0,10);
}
function addDaysISO(iso,days){ const d=new Date(iso); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }

/* Språk-etiketter */
function labelFor(key, lang){
  if(lang==='sv'){
    if(key==='paras') return 'Paragrafer';
    if(key==='q')     return 'Frågor';
    if(key==='reads') return 'Läs-skriftställen';
  }
  if(key==='paras') return 'Avsnitt';
  if(key==='q')     return 'Spørsmål';
  if(key==='reads') return 'Les-skriftsteder';
  return key;
}

/* ===========================
   Tilstand – WT
   =========================== */
let lang='no';
let paras=[], perParagraph=[], cumulative=[], totalParagraphs=0, questions=0, reads=0;
let started=false, paused=false, startTs=null, accum=0, tickHandle=null;

/* ===========================
   Last data (JSON)
   =========================== */
async function fetchJSON(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Fetch feilet: '+url);
  return await res.json();
}
async function loadYear(lang, year){
  const tries = [
    `data/${lang}-${year}.json`,
    `Data/${lang}-${year}.json`,
    `data/${lang}-${year}`,
    `Data/${lang}-${year}`
  ];
  for(const u of tries){
    try{ return await fetchJSON(`${u}?v=${Date.now().toString().slice(7)}`); }
    catch(e){}
  }
  throw new Error('Fant ingen datafil for ' + lang + ' ' + year);
}

async function hydrateOptions(){
  const today = new Date();
  const year = today.getFullYear();
  let items = [];
  try{
    const payloads = [];
    for(const y of [year, year+1]){
      try{ payloads.push(await loadYear(lang, y)); }catch(e){}
    }
    // aksepter {items:[...]} eller bare [...]
    items = payloads.flatMap(p => Array.isArray(p) ? p : (p?.items||[]));
  }catch(e){}

  const sel = $('#weekSel');
  sel.innerHTML='';

  if(!items.length){
    const opt=document.createElement('option');
    opt.textContent='Fant ingen datafiler (sjekk /data eller /Data i repoet).';
    opt.disabled=true; opt.selected=true;
    sel.appendChild(opt);
    $('#message').textContent='Ingen data lastet. Sjekk at filene heter data/no-2025.json eller Data/no-2025.json.';
    return;
  }

  const start = isoMonday(today);
  const targets = [0,7,14].map(x=>addDaysISO(start,x));
  const options = items.filter(it=>targets.includes(it.week_start))
                       .sort((a,b)=>a.week_start.localeCompare(b.week_start));

  if(options.length===0){
    const opt=document.createElement('option');
    const have = [...new Set(items.map(i=>i.week_start))].slice(0,6).join(', ');
    opt.textContent = `Ingen treff for ${targets.join(', ')}. Tilgjengelige: ${have||'–'}`;
    opt.disabled=true; opt.selected=true;
    sel.appendChild(opt);
    $('#message').textContent='Fant ingen ukesobjekter for inneværende uke + 2 fram. Sjekk week_start-datoene.';
    return;
  }

  options.forEach(it=>{
    const o=document.createElement('option');
    o.value = JSON.stringify(it);
    o.textContent = `${it.week_start} – ${it.title || '(uten tittel)'}`;
    sel.appendChild(o);
  });
  sel.selectedIndex=0;
  useItem(JSON.parse(sel.value));
}

function useItem(item){
  $('#articleTitle').textContent = item.title || '—';
  totalParagraphs = item.paragraphs|0;
  questions = item.questions|0;
  reads = item.reads|0;
  paras = (item.words||[]).map((w,i)=>({num:i+1, words:w|0, q:1, les:0, hasAB:false}));
  if(paras.length!==totalParagraphs){
    paras = Array.from({length: totalParagraphs}, (_,i)=>({num:i+1, words:0, q:1, les:0, hasAB:false}));
  }

  $('#pillParas').textContent = `${labelFor('paras',lang)}: ${totalParagraphs}`;
  $('#pillQ').textContent     = `${labelFor('q',lang)}: ${questions}`;
  $('#pillReads').textContent = `${labelFor('reads',lang)}: ${reads}`;

  computeAllocation(); drawTimeline(); resetClockUI();
  $('#message').textContent='Klar til start. Trykk ▶ når du er klar.';
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true;
}

/* ===========================
   Fordeling & timeline
   =========================== */
function computeAllocation(){
  if(totalParagraphs<=0){ perParagraph=[]; cumulative=[]; return; }
  const wps=WPM/60;
  const raw = Array.from({length: totalParagraphs}, (_,i)=>{
    const p = paras[i] || {words:0,q:1,les:0,hasAB:false};
    let sec = (p.words||0)/wps + (p.q||0)*SEC_PER_Q + (p.les||0)*SEC_PER_READ + (p.hasAB?AB_BONUS:0);
    return Math.max(5, sec);
  });
  const sum = raw.reduce((a,b)=>a+b,0)||1;
  const scale = CONTENT/sum;
  perParagraph = raw.map(x=>x*scale);
  cumulative=[]; let acc=INTRO;
  for(let i=0;i<totalParagraphs;i++){ cumulative.push(acc); acc+=perParagraph[i]; }
}
function hexToRgb(h){const s=h.replace('#','');const n=s.length===3?s.split('').map(x=>x+x).join(''):s;return{r:parseInt(n.slice(0,2),16),g:parseInt(n.slice(2,4),16),b:parseInt(n.slice(4,6),16)}}
function lerpColor(h1,h2,t){const a=hexToRgb(h1),b=hexToRgb(h2);const r=Math.round(a.r+(b.r-a.r)*t),g=Math.round(a.g+(b.g-a.g)*t),bl=Math.round(a.b+(b.b-a.b)*t);return`rgb(${r}, ${g}, ${bl})`}

function drawTimeline(){
  const t = $('#timeline');
  Array.from(t.querySelectorAll('.para-slot')).forEach(n=>n.remove());

  $('#introSlot').style.left='0%'; $('#introSlot').style.width=pct(INTRO).toFixed(4)+'%';
  $('#outroSlot').style.right='0%'; $('#outroSlot').style.width=pct(OUTRO).toFixed(4)+'%';
  $('#reviewSlot').style.right=pct(OUTRO).toFixed(4)+'%'; $('#reviewSlot').style.width=pct(REVIEW).toFixed(4)+'%';

  if(totalParagraphs<=0){ $('#elapsed').style.width='0%'; $('#cursor').style.left='0%'; return; }

  const timelinePx = t.clientWidth;
  const startCol='#e8f6ee', endCol='#bfe3ce';

  /* Dynamisk label-tetthet */
  const LABEL_W = 16;
  const stepBase = Math.max(1, Math.ceil((totalParagraphs * LABEL_W) / Math.max(1,timelinePx)));

  for(let i=1;i<=totalParagraphs;i++){
    const leftP = pct(cumulative[i-1]);
    const widthP= pct(perParagraph[i-1]);
    const widthPx = (perParagraph[i-1]/TOTAL)*timelinePx;

    const slot=document.createElement('div');
    slot.className='para-slot';
    slot.style.left=leftP+'%';
    slot.style.width=widthP+'%';

    const tN=(i-1)/Math.max(1,(totalParagraphs-1));
    slot.style.background=lerpColor(startCol,endCol,tN);

    const lbl=document.createElement('div');
    lbl.className='lbl';
    if(widthPx >= LABEL_W || ((i % stepBase)===0 || i===1 || i===totalParagraphs)){
      lbl.textContent = String(i);
    } else {
      lbl.textContent = '';
    }
    slot.appendChild(lbl);

    slot.addEventListener('click', ()=>{
      if(started && !paused) return;
      const target = cumulative[i-1];
      accum = Math.min(Math.round(target), TOTAL-OUTRO-REVIEW);
      const pNow = Math.min(accum/TOTAL*100,100);
      $('#elapsed').style.width=pNow+'%';
      $('#cursor').style.left=`calc(${pNow}% - 1px)`;
      $('#clockWT').textContent = fmt(accum);
      $('#clockWT').classList.toggle('over', accum>=TOTAL);
      $('#message').textContent = `${labelFor('paras',lang)} ${i}`;
    });

    t.insertBefore(slot, $('#elapsed'));
  }
  $('#elapsed').style.width='0%'; $('#cursor').style.left='0%';
}
let _rAF=null;
window.addEventListener('resize', ()=>{ if(_rAF) cancelAnimationFrame(_rAF); _rAF=requestAnimationFrame(()=>{ if(totalParagraphs>0) drawTimeline(); }); });

/* ===========================
   Klokke – WT
   =========================== */
function resetClockUI(){ if(tickHandle)clearInterval(tickHandle); $('#clockWT').textContent='00:00'; $('#clockWT').classList.remove('over'); }
function startClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=setInterval(tickWT,250); }
function stopClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=null; }
function nowElapsed(){ if(!started) return accum; if(paused) return accum; const live=Math.floor((Date.now()-startTs)/1000); return accum+live; }

function tickWT(){
  const e = nowElapsed();
  $('#clockWT').textContent = fmt(e);
  $('#clockWT').classList.toggle('over', e>=TOTAL);
  const p = Math.min(e/TOTAL*100,100);
  $('#elapsed').style.width=p+'%';
  $('#cursor').style.left=`calc(${p}% - 1px)`;

  if(e < INTRO) { $('#message').textContent='Introduksjon'; }
  else if(e >= TOTAL) { $('#message').textContent='Tiden er brukt – teller over'; }
  else if(e >= TOTAL-OUTRO) { $('#message').textContent='Avslutning'; }
  else if(e >= TOTAL-OUTRO-REVIEW) { $('#message').textContent='Repetisjonsspørsmål'; }
  else {
    let idx=0;
    for(let i=0;i<totalParagraphs;i++){
      const s=cumulative[i], end=(i===totalParagraphs-1)?(TOTAL-OUTRO-REVIEW):cumulative[i+1];
      if(e>=s && e<end){ idx=i; break; }
    }
    let msg=`${labelFor('paras',lang)} ${idx+1}`;
    if(e>=1800 && e<1860) msg+=' – du er halvveis';
    $('#message').textContent=msg;
  }
}

/* WT kontroller */
$('#playWT').addEventListener('click', ()=>{
  if(started && paused){
    paused=false; startTs=Date.now(); startClock();
    $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false;
    return;
  }
  if(!started){
    started=true; paused=false; startTs=Date.now(); startClock();
    $('#message').textContent='Introduksjon';
    $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false;
  }
});
$('#pauseWT').addEventListener('click', ()=>{
  if(!started || paused) return;
  accum += Math.floor((Date.now()-startTs)/1000); paused=true; stopClock();
  $('#message').textContent='Pause';
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=false;
});
$('#stopWT').addEventListener('click', ()=>{
  if(started && !paused) accum += Math.floor((Date.now()-startTs)/1000);
  started=false; paused=false; stopClock();
  $('#message').textContent=`Ferdig – totalt ${fmt(accum)}`;
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true;
  accum=0; resetClockUI();
  $('#elapsed').style.width='0%'; $('#cursor').style.left='0%';
});

/* ===========================
   FANER
   =========================== */
const views = { WT: $('#viewWT'), SP: $('#viewSP') };
const tabs  = { WT: $('#tabWT'), SP: $('#tabSP') };
function activateView(key){
  Object.entries(views).forEach(([k,el])=>el.classList.toggle('active', k===key));
  Object.entries(tabs).forEach(([k,btn])=>{
    btn.classList.toggle('active', k===key);
    btn.setAttribute('aria-selected', k===key?'true':'false');
  });
}
$('#tabWT').addEventListener('click', ()=>activateView('WT'));
$('#tabSP').addEventListener('click', ()=>activateView('SP'));

/* ===========================
   ANNET – nedtelling
   =========================== */
const PRESET_KEY='meetingTimer.annetSeconds';
const spPresets = Array.from(document.querySelectorAll('.preset-row .preset'));
let spRunning=false, spPaused=false, spStart=null, spAccum=0, spTick=null;
let SP_TOTAL = parseInt(localStorage.getItem(PRESET_KEY),10) || 600;

// meldingsflagg
let showStart=false, shownHalf=false, shownOneMin=false, shownOver=false;

function spFmt(s){ s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }
function spElapsed(){ if(!spRunning) return spAccum; if(spPaused) return spAccum; const live=Math.floor((Date.now()-spStart)/1000); return spAccum+live; }

function markPreset(sec){ spPresets.forEach(b=>b.classList.toggle('active', parseInt(b.dataset.sec,10)===sec)); }

function setStep(min, sec){
  min=Math.max(0,Math.min(999,min|0)); sec=Math.max(0,Math.min(59,sec|0));
  $('#minVal').textContent=String(min);
  $('#secVal').textContent=String(sec).padStart(2,'0');
  if(!spRunning){
    SP_TOTAL = min*60+sec;
    $('#clockSP').textContent=spFmt(SP_TOTAL);
    markPreset([1800,900,600,300].includes(SP_TOTAL)?SP_TOTAL:-1);
    localStorage.setItem(PRESET_KEY, String(SP_TOTAL));
  }
}

function resetFlags(){ showStart=false; shownHalf=false; shownOneMin=false; shownOver=false; }

/* — Bannerhjelpere for Annet — */
function showBannerForSeconds(sec){
  const box = document.getElementById('spBanner');
  const img = document.getElementById('spBannerImg');
  let src = '';
  if (sec === 1800) src = '30-min.png';
  else if (sec === 600) src = '10-min.png';
  if (src){
    img.src = src;
    img.alt = (sec===1800?'30':'10') + ' minutter';
    box.hidden = false;
  } else {
    box.hidden = true;
    img.removeAttribute('src');
    img.removeAttribute('alt');
  }
}
function hideBanner(){
  const box = document.getElementById('spBanner');
  const img = document.getElementById('spBannerImg');
  box.hidden = true;
  img.removeAttribute('src');
  img.removeAttribute('alt');
}

function interpColor(t){ const a=[0x1e,0x82,0x4c], b=[0xf0,0xad,0x4e]; const mix=i=>Math.round(a[i]+(b[i]-a[i])*(1-t)); return `rgb(${mix(0)}, ${mix(1)}, ${mix(2)})`; }

function updateSP(){
  const e=spElapsed();
  const remain = SP_TOTAL - e;
  const clock = $('#clockSP');

  if(spRunning && !spPaused){
    if(e<=10 && !showStart){ $('#msgSP').textContent='Vi er i gang'; showStart=true; }
    if(e>=Math.floor(SP_TOTAL/2) && !shownHalf){ $('#msgSP').textContent='Du er halvveis'; shownHalf=true; }
    if(remain===60 && !shownOneMin){ $('#msgSP').textContent='1 minutt igjen!'; shownOneMin=true; }
    if(remain<0 && !shownOver){ $('#msgSP').textContent='Du har gått over tiden!'; shownOver=true; }
  }else{
    $('#msgSP').textContent='Klar til nedtelling.';
  }

  if(remain>=0){
    clock.classList.remove('over');
    clock.textContent = spFmt(remain);
    clock.style.color = remain>60 ? '' : interpColor(Math.max(0,remain)/60);
  }else{
    clock.classList.add('over');
    clock.style.color = '';
    clock.textContent = spFmt(-remain);
  }
}
function spStartFn(){
  if(spRunning && spPaused){
    spPaused=false; spStart=Date.now(); spTick && clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false;
    showBannerForSeconds(SP_TOTAL);
    return;
  }
  if(!spRunning){
    spRunning=true; spPaused=false; spStart=Date.now(); spAccum=0; resetFlags();
    spTick && clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false;
    updateSP();
    showBannerForSeconds(SP_TOTAL);
  }
}
function spPauseFn(){
  if(!spRunning || spPaused) return;
  spAccum += Math.floor((Date.now()-spStart)/1000);
  spPaused=true; spTick && clearInterval(spTick); spTick=null;
  $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=false;
  updateSP();
}
function spStopFn(){
  if(spRunning && !spPaused) spAccum += Math.floor((Date.now()-spStart)/1000);
  spRunning=false; spPaused=false; spStart=null; spAccum=0;
  spTick && clearInterval(spTick); spTick=null;
  $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=true;
  $('#clockSP').classList.remove('over'); $('#clockSP').style.color='';
  $('#msgSP').textContent='Klar til nedtelling.';
  const s = parseInt(localStorage.getItem(PRESET_KEY),10) || 600;
  setStep(Math.floor(s/60), s%60);
  $('#clockSP').textContent=spFmt(s);
  hideBanner(); /* skjul banner ved stopp */
}
$('#playSP').addEventListener('click', spStartFn);
$('#pauseSP').addEventListener('click', spPauseFn);
$('#stopSP').addEventListener('click', spStopFn);

spPresets.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(spRunning) return;
    const s=parseInt(btn.dataset.sec,10)||600;
    localStorage.setItem(PRESET_KEY, String(s));
    markPreset(s);
    setStep(Math.floor(s/60), s%60);
    $('#clockSP').textContent=spFmt(s);
    $('#msgSP').textContent='Klar til nedtelling.';
  });
});
$('#minUp').addEventListener('click', ()=>{ if(spRunning) return; const m=parseInt(minVal.textContent,10)||0; setStep(m+1, parseInt(secVal.textContent,10)||0); });
$('#minDown').addEventListener('click', ()=>{ if(spRunning) return; const m=parseInt(minVal.textContent,10)||0; setStep(m-1, parseInt(secVal.textContent,10)||0); });
$('#secUp').addEventListener('click', ()=>{ if(spRunning) return; let s=(parseInt(secVal.textContent,10)||0)+1; let m=parseInt(minVal.textContent,10)||0; if(s>=60){ m++; s=0; } setStep(m,s); });
$('#secDown').addEventListener('click', ()=>{ if(spRunning) return; let s=(parseInt(secVal.textContent,10)||0)-1; let m=parseInt(minVal.textContent,10)||0; if(s<0){ if(m>0){ m--; s=59; } else { s=0; } } setStep(m,s); });

/* ===========================
   INIT
   =========================== */
(async function init(){
  const savedLang = localStorage.getItem('meetingTimer.lang');
  if(savedLang) $('#langSel').value = savedLang;
  lang = $('#langSel').value || 'no';

  // Annet – gjenopprett siste preset
  const s = parseInt(localStorage.getItem(PRESET_KEY),10) || 600;
  markPreset([1800,900,600,300].includes(s)?s:-1);
  setStep(Math.floor(s/60), s%60);
  $('#clockSP').textContent=spFmt(s);

  await hydrateOptions();
})();
</script>
</body>
</html>
