<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Meeting Timer – Study Analyzer (Norsk)</title>
<style>
  :root{
    --bg:#f7f8fb; --fg:#0f1b2b; --muted:#6c7784;
    --card:#ffffff; --border:#dfe3e8; --accent:#0d6efd; --good:#28a745; --warn:#f0ad4e;
    --radius:14px;
  }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
  .container{ max-width:980px; margin:24px auto; padding:0 16px }
  h1{ margin:0 0 12px }
  .row{ display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start }
  .col{ flex:1 1 460px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 8px 30px rgba(0,0,0,.06) }
  .card h2{ font-size:1rem; margin:0; padding:12px 14px; border-bottom:1px solid var(--border) }
  .card .body{ padding:12px 14px }
  textarea{ width:100%; min-height:320px; resize:vertical; padding:12px; font-size:15px; border:1px solid var(--border); border-radius:12px; }
  input[type="text"], input[type="date"]{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:15px; background:#fff;
  }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .rowline{ display:flex; gap:12px; align-items:center }
  .rowline > *{ flex:1 }
  .btn{ display:inline-flex; align-items:center; gap:8px; background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:700 }
  .btn.secondary{ background:#eef2f7; color:#0f1b2b; border:1px solid var(--border) }
  .btn.good{ background:var(--good) }
  .btn.warn{ background:var(--warn) }
  pre{ background:#0f172a; color:#e2e8f0; padding:12px; border-radius:12px; overflow:auto; font-size:13px }
  .muted{ color:var(--muted); font-size:.95rem }
  .pill{ display:inline-block; padding:3px 8px; border-radius:999px; background:#eef2f7; border:1px solid var(--border); font-size:.85rem; }
  .kpi{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .kpi .pill strong{ margin-right:4px }
  .ok{ color:var(--good) } .warntext{ color:#c57a00 }
</style>
</head>
<body>
<div class="container">
  <h1>Meeting Timer – Study Analyzer <span class="muted">(Norsk)</span></h1>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2>1) Lim inn artikkeltekst</h2>
        <div class="body">
          <textarea id="src" placeholder="Lim inn hele studieartikkelen her …"></textarea>
          <div class="rowline" style="margin-top:10px">
            <button id="analyzeBtn" class="btn">Analyser</button>
            <button id="clearBtn" class="btn secondary">Tøm</button>
          </div>
          <p class="muted" style="margin-top:8px">
            Tips: Kopiér hele artikkelen fra <em>wol.jw.org</em> (inkl. avsnittstall).
          </p>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h2>2) Metadata</h2>
        <div class="body">

          <div style="margin-top:0">
            <label for="week">Uke (mandag)</label>
            <input type="date" id="week" />
          </div>

          <div style="margin-top:12px">
            <label for="title">Tittel</label>
            <input type="text" id="title" placeholder="Tittel foreslås automatisk">
          </div>

          <div style="margin-top:12px">
            <label for="paragraphs">Antall avsnitt</label>
            <input type="text" id="paragraphs" inputmode="numeric" placeholder="F.eks. 21">
          </div>

          <div class="grid" style="margin-top:12px">
            <div>
              <label for="groups">Avsnittsgrupper</label>
              <input type="text" id="groups" placeholder="F.eks. 1-2, 7-8">
            </div>
            <div>
              <label for="images">Bilder</label>
              <input type="text" id="images" placeholder="F.eks. 6, 11, 14-15">
            </div>
          </div>

          <div class="grid" style="margin-top:12px">
            <div>
              <label for="reads">Les-skriftsteder</label>
              <input type="text" id="reads" placeholder="F.eks. 5, 12">
            </div>
            <div>
              <label for="frames">Rammer</label>
              <input type="text" id="frames" placeholder="F.eks. 9, 10-11">
            </div>
          </div>

          <div class="kpi" id="kpi"></div>
        </div>
      </div>
    </div>
  </div><!-- /row -->

  <div class="card" style="margin-top:16px">
    <h2>3) JSON-resultat</h2>
    <div class="body">
      <pre id="jsonOut">{}</pre>
      <div class="rowline">
        <button id="copyBtn" class="btn good">Kopier JSON</button>
        <span id="copyHint" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:8px">
        Lim inn som én linje i <code>data/no-YYYY.json</code> under <code>"items"</code>.
      </p>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Notater</h2>
    <div class="body">
      <ul class="muted">
        <li>Antall avsnitt og paragraf-lengder hentes automatisk når du klikker «Analyser».</li>
        <li>«Les …»-forekomster brukes bare til å anslå lengden på avsnittene.</li>
        <li>Tittel-filtrering ignorerer linjer av typen <em>«…» – Skriftsted</em>.</li>
      </ul>
    </div>
  </div>
</div>

<script>
/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);

function isoMonday(d=new Date()){
  const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const day = (dt.getUTCDay()+6)%7; // 0 = Monday
  dt.setUTCDate(dt.getUTCDate()-day);
  return dt.toISOString().slice(0,10);
}

// Brukes til å parse lister som "6, 11, 14-15, 3a"
function parseListField(str){
  if(!str) return [];
  return str
    .split(',')
    .map(s => s.trim())
    .filter(Boolean)
    .map(tok => /^\d+$/.test(tok) ? Number(tok) : tok);
}

/* ========= Language / scripture regex (kun norsk) ========= */
function scriptureKeyword(){ return 'Les'; }

function scriptureRegex(){
  const word = scriptureKeyword();
  return new RegExp(
    `\\b${word}\\b\\s*:?\\s*\\(?\\s*` +
    `(?:[1-3]?\\.?\\s*[\\p{L}][\\p{L}\\p{M}.\\-\\s]*?)?` +
    `\\s*\\d+\\s*:\\s*\\d+(?:\\s*[–-]\\s*\\d+)?`,
    'giu'
  );
}

/* ========= Title heuristics ========= */
const HEADER_RE = /^(\d+(?:[\s\u00A0]*,[\s\u00A0]*\d+)*)\.\s*(.*)?$/;
const BODY_START_RE = /^(\d+)[\.\s\u00A0]+(.*)$/;

// filter ut ting vi ikke vil ha som tittel
const titleBlacklist = /^(Publikasjoner|STUDIEARTIKKEL\b|SANG\b|FOKUS\b|Underoverskrifter|Lignende stoff|Audio Player|Norsk\b|Del\b|Innstillinger\b|Logg inn\b|JW\.ORG\b|HVA SVARER DU\b|w\d{2}\b)/i;
// «…» + dash (– — -) + skriftsted
const quoteTheme = /^\s*(«[^»]+»|".+")\s*[–—-]\s*[1-3]?\s*[A-ZÆØÅ][A-Za-zÆØÅæøå.\- ]*\d/i;
// generell skr.ref
const hasRef = /[1-3]?\s*[A-ZÆØÅ][A-Za-zÆØÅæøå.\- ]*\d+\s*:\s*\d+/;

function pickTitle(lines){
  const tooMany = s => s.split(/\s+/).length > 16;

  // NY regel: se etter wXX + måned + s.
  for (let i=0; i<lines.length; i++){
    const l = lines[i].trim();
    if (/^w\d{2}\s+[a-zæøå]+\s+s\./i.test(l)){
      const candidate = (lines[i].replace(/^w\d{2}.*?s\.\s*/i,'').trim()) || (lines[i+1]||'').trim();
      if (candidate && candidate.length > 6 && candidate.length < 160){
        return candidate;
      }
    }
  }

  const idxSong = lines.findIndex(l => /^(SANG)[\s\u00A0]*\d+/i.test(l||''));
  if (idxSong >= 0){
    const zone = lines.slice(idxSong+1, idxSong+9);
    const cands = zone.filter(raw=>{
      const s=(raw||'').trim();
      if(!s) return false;
      if (titleBlacklist.test(s)) return false;
      if (/^\d/.test(s)) return false;
      if (!/[A-Za-zÆØÅæøå]/.test(s) || !/[a-zæøå]/.test(s)) return false;
      if (tooMany(s)) return false;
      if (quoteTheme.test(s)) return false;
      if (hasRef.test(s)) return false;
      return s.length>=6 && s.length<=160;
    });
    if (cands.length){
      const score = s => (/[–—-]/.test(s)?1:0) + Math.max(0, 16 - s.split(/\s+/).length);
      cands.sort((a,b)=>score(b)-score(a));
      return cands[0];
    }
  }

  const firstPara = lines.findIndex(l => HEADER_RE.test(l||'') || BODY_START_RE.test(l||''));
  const headerZone = firstPara > -1 ? lines.slice(0, firstPara) : lines.slice(0, 30);

  const clean=[], fallback=[];
  for(const raw of headerZone){
    const s=(raw||'').trim();
    if(!s) continue;
    if (titleBlacklist.test(s)) continue;
    if (/^\d/.test(s)) continue;
    if (!/[A-Za-zÆØÅæøå]/.test(s) || !/[a-zæøå]/.test(s)) continue;
    if (s.split(/\s+/).length > 16) continue;
    if (s.length<6 || s.length>160) continue;

    if (!quoteTheme.test(s) && !hasRef.test(s)) clean.push(s);
    else fallback.push(s);
  }
  const pickBest = arr => arr.sort((a,b)=>{
    const score = s => (/[–—-]/.test(s)?1:0) + Math.max(0, 16 - s.split(/\s+/).length);
    return score(b)-score(a);
  })[0] || '';
  return pickBest(clean) || pickBest(fallback) || '';
}

/* ========= Paragraph extraction ========= */
function extractParagraphs(text){
  const norm = (text||'').replace(/\u00A0/g,' ').replace(/\u202F/g,' ');
  const lines = norm.split('\n').map(l=>l.trim()).filter(Boolean);

  const paras = [];
  let pendingNums=[], currentNum=null, buf=[];
  const lesRe = scriptureRegex();
  const skip = /^(HVA SVARER DU|Svaret ditt)$/i;

  function push(){
    if (currentNum!==null){
      const t = buf.join(' ').trim();
      const words = (t.match(/\S+/g)||[]).length;
      const q = 1;
      const les = (t.match(lesRe)||[]).length;
      paras.push({ num: currentNum, text: t, words, q, les });
    }
    buf=[];
  }

  for(const raw of lines){
    const l = raw.replace(/\u00A0/g,' ').trim();
    if(!l || skip.test(l)) continue;

    const h = l.match(/^(\d+(?:\s*,\s*\d+)*)\.\s*(.*)?$/);
    if(h){
      push();
      pendingNums = h[1].split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n));
      currentNum = pendingNums.shift() ?? null;
      const head = (h[2]||'').trim();
      if(head) buf.push(head);
      continue;
    }
    const b = l.match(/^(\d+)[\.\s]+(.*)$/);
    if(b){
      const n = parseInt(b[1],10);
      const rest = (b[2]||'').trim();
      if (currentNum===null || n!==currentNum){ push(); currentNum=n; }
      if (rest) buf.push(rest);
      continue;
    }
    buf.push(l);
  }
  push();

  if (paras.length < 8) {
    const joined = lines.join('\n');
    const blocks = joined.split(/(?:(?:^)|(?:\n))(?=\s*\d+(?:\s*,\s*\d+)*\.\s)/g)
      .map(s=>s.trim()).filter(Boolean);
    const extra=[];
    for(const block of blocks){
      const m = block.match(/^(\d+(?:\s*,\s*\d+)*)\.\s*(.*)$/s);
      if(!m) continue;
      const nums = m[1].split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n));
      let body  = (m[2]||'').trim();
      const bodyStart = body.match(/^(\d+)[\.\s]+(.*)$/s);
      if(bodyStart && nums.length && parseInt(bodyStart[1],10)===nums[0]){
        body = (bodyStart[2]||'').trim();
      }
      nums.forEach(n=>{
        const words=(body.match(/\S+/g)||[]).length, q=1, les=(body.match(lesRe)||[]).length;
        extra.push({ num:n, text:body, words, q, les });
      });
    }
    if (extra.length > paras.length){
      const seen=new Set();
      const merged=[...paras, ...extra].sort((a,b)=>a.num-b.num).filter(p=>{
        if(seen.has(p.num)) return false; seen.add(p.num); return true;
      });
      return { lines, paras: merged };
    }
  }
  return { lines, paras };
}

/* ========= Render / Analyze ========= */
function recompute(){
  const title = $('#title').value.trim();
  const week  = $('#week').value || isoMonday();

  let words = Array.isArray(window._lastWords) ? [...window._lastWords] : [];
  const paraField = parseInt($('#paragraphs').value||'0',10) || 0;

  if(paraField > 0){
    if(paraField > words.length){
      const diff = paraField - words.length;
      words = words.concat(Array(diff).fill(0));
    }else if(paraField < words.length){
      words = words.slice(0, paraField);
    }
  }
  const paragraphs = words.length;
  window._lastWords = words;

  const groupStr = $('#groups').value.trim();
  const imagesArr = parseListField($('#images').value.trim());
  const readsArr  = parseListField($('#reads').value.trim());
  const framesArr = parseListField($('#frames').value.trim());

  const obj = {
    week_start: week,
    title,
    groups: groupStr,
    frames: framesArr,
    reads: readsArr,
    para_lengths: words,
    images: imagesArr
  };

  // Én linje JSON, klar til å limes inn i articles-data.json
  $('#jsonOut').textContent = JSON.stringify(obj);

  // KPIs
  const totalWords = words.reduce((a,b)=>a+b,0);
  const kpi = $('#kpi');
  kpi.innerHTML = `
    <span class="pill"><strong>${paragraphs}</strong> avsnitt</span>
    <span class="pill"><strong>${imagesArr.length}</strong> bilder</span>
    <span class="pill"><strong>${readsArr.length}</strong> les-skriftsteder</span>
    <span class="pill"><strong>${framesArr.length}</strong> rammer</span>
    <span class="pill"><strong>${totalWords}</strong> ord totalt</span>
  `;
}

function analyze(){
  const raw = $('#src').value.trim();
  if(!raw){
    alert('Lim inn artikkelen først.');
    return;
  }

  const lang = 'no';

  const { lines, paras } = extractParagraphs(raw, lang);

  const title = pickTitle(lines) || '';

  const words = paras.map(p => p.words);
  const paragraphs = paras.length;

  $('#title').value = title;
  $('#paragraphs').value = String(paragraphs);

  window._lastWords = words;

  if (!$('#week').value) $('#week').value = isoMonday();

  recompute();
}

/* ========= Events ========= */
$('#analyzeBtn').addEventListener('click', analyze);
$('#clearBtn').addEventListener('click', ()=>{
  $('#src').value = '';
});

['#title','#paragraphs','#groups','#images','#reads','#frames','#week'].forEach(sel=>{
  const el = $(sel);
  if(!el) return;
  el.addEventListener('input', recompute);
});

$('#copyBtn').addEventListener('click', async ()=>{
  const txt = $('#jsonOut').textContent;
  try{
    await navigator.clipboard.writeText(txt);
    $('#copyHint').textContent = 'Kopiert!';
    setTimeout(()=>$('#copyHint').textContent='', 1500);
  }catch{
    $('#copyHint').textContent = 'Klarte ikke kopiere – marker teksten og kopier manuelt.';
  }
});

/* ========= Init ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#week').value = isoMonday();
});
</script>
</body>
</html>
