<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Meeting Timer – Study Analyzer (Norsk)</title>
<style>
  :root{
    --bg:#f8f7f5; 
    --ink:#2b3432; 
    --muted:#8b827a;
    --card:#ffffff; 
    --border:rgba(40,30,20,.10);
    --green:#6ecf9e;
    --press:#cfc7bd; 
    --pill:#fffefb; 
    --radius:16px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%}
  body{
    color:var(--ink);
    font-family:"Nunito",ui-rounded,-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    letter-spacing:.01em;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100%;
    background-color:var(--bg);
    background-image:
      linear-gradient(rgba(255,255,255,.82),rgba(255,255,255,.82)),
      url('./img/paper-texture.png');
    background-size:auto, 300px 300px;
    background-attachment:fixed;
  }
  .container{
    max-width:980px;
    margin:24px auto 40px;
    padding:0 16px;
  }
  h1{
    margin:0 0 12px;
    font-size:1.5rem;
    font-weight:800;
  }
  h1 .muted{
    font-weight:500;
    font-size:.9rem;
    margin-left:6px;
  }
  .row{ display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start }
  .col{ flex:1 1 460px }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:0 14px 40px rgba(0,0,0,.08);
    backdrop-filter:blur(4px);
  }
  .card h2{
    font-size:1rem;
    margin:0;
    padding:12px 16px 10px;
    border-bottom:1px solid rgba(40,30,20,.06);
    font-weight:700;
  }
  .card .body{ padding:12px 16px 14px }

  textarea{
    width:100%;
    min-height:320px;
    resize:vertical;
    padding:12px 12px 10px;
    font-size:15px;
    border:1px solid rgba(40,30,20,.16);
    border-radius:14px;
    outline:none;
    background:#fdfbf8;
    box-shadow:inset 0 1px 2px rgba(0,0,0,.04);
  }
  textarea:focus{
    border-color:rgba(110,207,158,.9);
    box-shadow:0 0 0 1px rgba(110,207,158,.35);
    background:#fffcf7;
  }

  input[type="text"], select{
    width:100%;
    padding:9px 12px;
    border:1px solid rgba(40,30,20,.16);
    border-radius:999px;
    font-size:15px;
    background:#fffcf7;
    outline:none;
  }
  input[type="text"]:focus, select:focus{
    border-color:rgba(110,207,158,.9);
    box-shadow:0 0 0 1px rgba(110,207,158,.35);
    background:#fffefb;
  }

  label{
    display:block;
    font-size:.85rem;
    margin-bottom:4px;
    color:var(--muted);
    font-weight:600;
  }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .rowline{ display:flex; gap:12px; align-items:center }
  .rowline > *{ flex:1 }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    border:0;
    padding:9px 16px 10px;
    border-radius:999px;
    cursor:pointer;
    font-weight:800;
    font-size:.95rem;
    letter-spacing:.02em;
    background-image:linear-gradient(135deg,#6ecf9e,#3cb979);
    color:#123424;
    box-shadow:0 7px 16px rgba(0,0,0,.18);
    transform:translateY(0);
    transition:box-shadow .12s ease, transform .12s ease, filter .12s ease;
  }
  .btn.secondary{
    background-image:none;
    background:#fffefb;
    color:var(--ink);
    border:1px solid rgba(40,30,20,.16);
    box-shadow:0 3px 10px rgba(0,0,0,.06);
  }
  .btn.good{
    background-image:linear-gradient(135deg,#6ecf9e,#3cb979);
  }
  .btn.warn{
    background-image:linear-gradient(135deg,#ffb766,#ff9b3a);
    color:#4b2a06;
  }
  .btn:active{
    transform:translateY(1px);
    box-shadow:0 4px 10px rgba(0,0,0,.18);
    filter:brightness(.97);
  }

  pre{
    background:#151b26;
    color:#e2e8f0;
    padding:10px 12px;
    border-radius:12px;
    overflow:auto;
    font-size:13px;
    border:1px solid rgba(255,255,255,.05);
  }
  .muted{ color:var(--muted); font-size:.95rem }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:3px 9px 4px;
    border-radius:999px;
    background:var(--pill);
    border:1px solid rgba(40,30,20,.12);
    font-size:.8rem;
  }
  .kpi{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px
  }
  .kpi .pill strong{ font-weight:700 }

  ul.muted{ padding-left:18px; margin:0; }
  ul.muted li{ margin-bottom:3px; }

  @media (max-width:720px){
    .card{ box-shadow:0 10px 26px rgba(0,0,0,.08); }
  }
</style>
</head>
<body>
<div class="container">
  <h1>Meeting Timer – Study Analyzer <span class="muted">(Norsk)</span></h1>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2>1) Lim inn artikkeltekst</h2>
        <div class="body">
          <textarea id="src" placeholder="Lim inn hele studieartikkelen her …"></textarea>
          <div class="rowline" style="margin-top:10px">
            <button id="analyzeBtn" class="btn">Analyser</button>
            <button id="clearBtn" class="btn secondary">Tøm</button>
          </div>
          <p class="muted" style="margin-top:8px">
            Tips: Kopiér hele artikkelen fra <em>wol.jw.org</em> (inkl. avsnittstall).
          </p>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h2>2) Metadata</h2>
        <div class="body">

          <div style="margin-top:0">
            <label for="week">Uke (mandag)</label>
            <select id="week"></select>
          </div>

          <div style="margin-top:12px">
            <label for="title">Tittel</label>
            <input type="text" id="title" placeholder="Tittel foreslås automatisk">
          </div>

          <div style="margin-top:12px">
            <label for="paragraphs">Antall avsnitt</label>
            <input type="text" id="paragraphs" inputmode="numeric" placeholder="F.eks. 21">
          </div>

          <div class="grid" style="margin-top:12px">
            <div>
              <label for="groups">Avsnittsgrupper</label>
              <input type="text" id="groups" placeholder="F.eks. 1-2, 7-8">
            </div>
            <div>
              <label for="images">Bilder</label>
              <input type="text" id="images" placeholder="F.eks. 6, 11, 14-15">
            </div>
          </div>

          <div class="grid" style="margin-top:12px">
            <div>
              <label for="reads">Les-skriftsteder</label>
              <input type="text" id="reads" placeholder="F.eks. 5, 12">
            </div>
            <div>
              <label for="frames">Rammer</label>
              <input type="text" id="frames" placeholder="F.eks. 9, 10-11">
            </div>
          </div>

          <div class="kpi" id="kpi"></div>
        </div>
      </div>
    </div>
  </div><!-- /row -->

  <div class="card" style="margin-top:16px">
    <h2>3) JSON-resultat</h2>
    <div class="body">
      <pre id="jsonOut">{},</pre>
      <div class="rowline">
        <button id="copyBtn" class="btn good">Kopier JSON</button>
        <span id="copyHint" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:8px">
        Lim inn som én linje i <code>data/no-YYYY.json</code> under <code>"items"</code>.
      </p>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Notater</h2>
    <div class="body">
      <ul class="muted">
        <li>Antall avsnitt og paragraf-lengder hentes automatisk når du klikker «Analyser».</li>
        <li>«Les …»-forekomster brukes bare til å anslå lengden på avsnittene.</li>
        <li>Tittel-filtrering ignorerer linjer av typen <em>«…» – Skriftsted</em>, og ledende tall fjernes.</li>
      </ul>
    </div>
  </div>
</div>

<script>
/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);

// Finn mandagen i denne uken (ISO) – brukes også som base for +4 uker
function isoMonday(d=new Date()){
  const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const day = (dt.getUTCDay()+6)%7; // 0 = mandag
  dt.setUTCDate(dt.getUTCDate()-day);
  return dt.toISOString().slice(0,10);
}

function addDaysIso(iso, days){
  const d = new Date(iso + 'T00:00:00Z');
  d.setUTCDate(d.getUTCDate()+days);
  return d.toISOString().slice(0,10);
}

// Generer mandager fra start av inneværende år til +3 år
function buildWeekOptions(){
  const select = $('#week');
  const now = new Date();
  const startYear = now.getFullYear();
  const endYear = startYear + 3;

  let d = new Date(Date.UTC(startYear, 0, 1));
  const day = d.getUTCDay(); // 0=søn, 1=man
  const offset = (day === 0 ? 1 : (day === 1 ? 0 : 8 - day));
  d.setUTCDate(d.getUTCDate() + offset);

  const options = [];
  while (d.getUTCFullYear() <= endYear){
    const iso = d.toISOString().slice(0,10); // yyyy-mm-dd
    const dd = String(d.getUTCDate()).padStart(2,'0');
    const mm = String(d.getUTCMonth()+1).padStart(2,'0');
    const yyyy = d.getUTCFullYear();
    const label = `${dd}.${mm}.${yyyy}`;
    options.push({value: iso, label});
    d.setUTCDate(d.getUTCDate()+7); // neste mandag
  }

  select.innerHTML = options.map(o =>
    `<option value="${o.value}">${o.label}</option>`
  ).join('');

  // Forslå mandagen 4 uker etter uken vi er i
  const baseMonday = isoMonday();
  const suggestionIso = addDaysIso(baseMonday, 28); // 4 x 7 dager

  let chosen = options.find(o => o.value === suggestionIso);
  if (!chosen){
    chosen = options.find(o => o.value > suggestionIso) || options[options.length-1];
  }
  if (chosen){
    select.value = chosen.value;
  }
}

// Brukes til å parse lister som "6, 11, 14-15, 3a"
function parseListField(str){
  if(!str) return [];
  return str
    .split(',')
    .map(s => s.trim())
    .filter(Boolean)
    .map(tok => /^\d+$/.test(tok) ? Number(tok) : tok);
}

/* ========= Language / scripture regex (kun norsk) ========= */
function scriptureKeyword(){ return 'Les'; }

function scriptureRegex(){
  const word = scriptureKeyword();
  return new RegExp(
    `\\b${word}\\b\\s*:?\\s*\\(?\\s*` +
    `(?:[1-3]?\\.?\\s*[\\p{L}][\\p{L}\\p{M}.\\-\\s]*?)?` +
    `\\s*\\d+\\s*:\\s*\\d+(?:\\s*[–-]\\s*\\d+)?`,
    'giu'
  );
}

/* ========= Title helpers ========= */

// Fjern ledende tall/intervall + bindestrek/tegn i starten av tittelen.
// Eksempler:
// "10–15Hjelp til deg ..." -> "Hjelp til deg ..."
// "1. Hvordan ..." -> "Hvordan ..."
// "3 - 4  Gled deg ..." -> "Gled deg ..."
function stripLeadingTitleNumbers(s){
  return (s||'').replace(/^\s*\d+(?:\s*[–—-]\s*\d+)?\s*[.\-–—:]?\s*/, '');
}

/* ========= Title heuristics ========= */
const HEADER_RE = /^(\d+(?:[\s\u00A0]*,[\s\u00A0]*\d+)*)\.\s*(.*)?$/;
const BODY_START_RE = /^(\d+)[\.\s\u00A0]+(.*)$/;

const titleBlacklist = /^(Publikasjoner|STUDIEARTIKKEL\b|SANG\b|FOKUS\b|Underoverskrifter|Lignende stoff|Audio Player|Norsk\b|Del\b|Innstillinger\b|Logg inn\b|JW\.ORG\b|HVA SVARER DU\b|w\d{2}\b)/i;
const quoteTheme = /^\s*(«[^»]+»|".+")\s*[–—-]\s*[1-3]?\s*[A-ZÆØÅ][A-Za-zÆØÅæøå.\- ]*\d/i;
const hasRef = /[1-3]?\s*[A-ZÆØÅ][A-Za-zÆØÅæøå.\- ]*\d+\s*:\s*\d+/;

function pickTitle(lines){
  const tooMany = s => s.split(/\s+/).length > 16;

  // Se etter wXX + måned + s.
  for (let i=0; i<lines.length; i++){
    const l = (lines[i]||'').trim();
    if (/^w\d{2}\s+[a-zæøå]+\s+s\./i.test(l)){
      const raw = (lines[i].replace(/^w\d{2}.*?s\.\s*/i,'').trim()) || (lines[i+1]||'').trim();
      const candidate = stripLeadingTitleNumbers(raw);
      if (candidate && candidate.length > 6 && candidate.length < 160){
        return candidate;
      }
    }
  }

  const idxSong = lines.findIndex(l => /^(SANG)[\s\u00A0]*\d+/i.test(l||''));
  if (idxSong >= 0){
    const zone = lines.slice(idxSong+1, idxSong+9);
    const cands = zone.filter(raw=>{
      const s=(raw||'').trim();
      if(!s) return false;
      if (titleBlacklist.test(s)) return false;
      if (/^\d/.test(s)) return false;
      if (!/[A-Za-zÆØÅæøå]/.test(s) || !/[a-zæøå]/.test(s)) return false;
      if (tooMany(s)) return false;
      if (quoteTheme.test(s)) return false;
      if (hasRef.test(s)) return false;
      return s.length>=6 && s.length<=160;
    });
    if (cands.length){
      const score = s => (/[–—-]/.test(s)?1:0) + Math.max(0, 16 - s.split(/\s+/).length);
      cands.sort((a,b)=>score(b)-score(a));
      return stripLeadingTitleNumbers(cands[0]);
    }
  }

  const firstPara = lines.findIndex(l => HEADER_RE.test(l||'') || BODY_START_RE.test(l||''));
  const headerZone = firstPara > -1 ? lines.slice(0, firstPara) : lines.slice(0, 30);

  const clean=[], fallback=[];
  for(const raw of headerZone){
    const s=(raw||'').trim();
    if(!s) continue;
    if (titleBlacklist.test(s)) continue;
    if (/^\d/.test(s)) continue;
    if (!/[A-Za-zÆØÅæøå]/.test(s) || !/[a-zæøå]/.test(s)) continue;
    if (s.split(/\s+/).length > 16) continue;
    if (s.length<6 || s.length>160) continue;

    if (!quoteTheme.test(s) && !hasRef.test(s)) clean.push(s);
    else fallback.push(s);
  }
  const pickBest = arr => arr.sort((a,b)=>{
    const score = s => (/[–—-]/.test(s)?1:0) + Math.max(0, 16 - s.split(/\s+/).length);
    return score(b)-score(a);
  })[0] || '';

  const chosen = pickBest(clean) || pickBest(fallback) || '';
  return stripLeadingTitleNumbers(chosen);
}

/* ========= Paragraph extraction ========= */
function extractParagraphs(text){
  const norm = (text||'').replace(/\u00A0/g,' ').replace(/\u202F/g,' ');
  const lines = norm.split('\n').map(l=>l.trim()).filter(Boolean);

  const paras = [];
  let pendingNums=[], currentNum=null, buf=[];
  const lesRe = scriptureRegex();
  const skip = /^(HVA SVARER DU|Svaret ditt)$/i;

  function push(){
    if (currentNum!==null){
      const t = buf.join(' ').trim();
      const words = (t.match(/\S+/g)||[]).length;
      const q = 1;
      const les = (t.match(lesRe)||[]).length;
      paras.push({ num: currentNum, text: t, words, q, les });
    }
    buf=[];
  }

  for(const raw of lines){
    const l = raw.replace(/\u00A0/g,' ').trim();
    if(!l || skip.test(l)) continue;

    const h = l.match(/^(\d+(?:\s*,\s*\d+)*)\.\s*(.*)?$/);
    if(h){
      push();
      pendingNums = h[1].split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n));
      currentNum = pendingNums.shift() ?? null;
      const head = (h[2]||'').trim();
      if(head) buf.push(head);
      continue;
    }
    const b = l.match(/^(\d+)[\.\s]+(.*)$/);
    if(b){
      const n = parseInt(b[1],10);
      const rest = (b[2]||'').trim();
      if (currentNum===null || n!==currentNum){ push(); currentNum=n; }
      if (rest) buf.push(rest);
      continue;
    }
    buf.push(l);
  }
  push();

  if (paras.length < 8) {
    const joined = lines.join('\n');
    const blocks = joined.split(/(?:(?:^)|(?:\n))(?=\s*\d+(?:\s*,\s*\d+)*\.\s)/g)
      .map(s=>s.trim()).filter(Boolean);
    const extra=[];
    for(const block of blocks){
      const m = block.match(/^(\d+(?:\s*,\s*\d+)*)\.\s*(.*)$/s);
      if(!m) continue;
      const nums = m[1].split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n));
      let body  = (m[2]||'').trim();
      const bodyStart = body.match(/^(\d+)[\.\s]+(.*)$/s);
      if(bodyStart && nums.length && parseInt(bodyStart[1],10)===nums[0]){
        body = (bodyStart[2]||'').trim();
      }
      nums.forEach(n=>{
        const words=(body.match(/\S+/g)||[]).length, q=1, les=(body.match(lesRe)||[]).length;
        extra.push({ num:n, text:body, words, q, les });
      });
    }
    if (extra.length > paras.length){
      const seen=new Set();
      const merged=[...paras, ...extra].sort((a,b)=>a.num-b.num).filter(p=>{
        if(seen.has(p.num)) return false; seen.add(p.num); return true;
      });
      return { lines, paras: merged };
    }
  }
  return { lines, paras };
}

/* ========= Render / Analyze ========= */
function recompute(){
  const title = $('#title').value.trim();
  const week  = $('#week').value || isoMonday();

  let words = Array.isArray(window._lastWords) ? [...window._lastWords] : [];
  const paraField = parseInt($('#paragraphs').value||'0',10) || 0;

  if(paraField > 0){
    if(paraField > words.length){
      const diff = paraField - words.length;
      words = words.concat(Array(diff).fill(0));
    }else if(paraField < words.length){
      words = words.slice(0, paraField);
    }
  }
  const paragraphs = words.length;
  window._lastWords = words;

  const groupStr = $('#groups').value.trim();
  const imagesArr = parseListField($('#images').value.trim());
  const readsArr  = parseListField($('#reads').value.trim());
  const framesArr = parseListField($('#frames').value.trim());

  const obj = {
    week_start: week,
    title,
    groups: groupStr,
    frames: framesArr,
    reads: readsArr,
    para_lengths: words,
    images: imagesArr
  };

  // Én linje JSON, med komma til slutt
  $('#jsonOut').textContent = JSON.stringify(obj) + ',';

  // KPIs
  const totalWords = words.reduce((a,b)=>a+b,0);
  const kpi = $('#kpi');
  kpi.innerHTML = `
    <span class="pill"><strong>${paragraphs}</strong> avsnitt</span>
    <span class="pill"><strong>${imagesArr.length}</strong> bilder</span>
    <span class="pill"><strong>${readsArr.length}</strong> les-skriftsteder</span>
    <span class="pill"><strong>${framesArr.length}</strong> rammer</span>
    <span class="pill"><strong>${totalWords}</strong> ord totalt</span>
  `;
}

function analyze(){
  const raw = $('#src').value.trim();
  if(!raw){
    alert('Lim inn artikkelen først.');
    return;
  }

  const { lines, paras } = extractParagraphs(raw);

  const rawTitle = pickTitle(lines) || '';
  const title = stripLeadingTitleNumbers(rawTitle);

  const words = paras.map(p => p.words);
  const paragraphs = paras.length;

  $('#title').value = title;
  $('#paragraphs').value = String(paragraphs);

  window._lastWords = words;

  recompute();
}

/* ========= Events ========= */
$('#analyzeBtn').addEventListener('click', analyze);
$('#clearBtn').addEventListener('click', () => {
  // Tøm hovedtekst
  $('#src').value = '';

  // Tøm metadata-feltene
  $('#title').value = '';
  $('#paragraphs').value = '';
  $('#groups').value = '';
  $('#images').value = '';
  $('#reads').value = '';
  $('#frames').value = '';

  // Nullstill interne data
  window._lastWords = [];

  // Sett uke-feltet tilbake til standard (mandag 4 uker fram i tid)
  buildWeekOptions();

  // Nullstill JSON-visning, KPI-pillene og kopi-hintet
  $('#jsonOut').textContent = '{},';
  $('#kpi').innerHTML = '';
  $('#copyHint').textContent = '';
});

['#title','#paragraphs','#groups','#images','#reads','#frames','#week'].forEach(sel=>{
  const el = $(sel);
  if(!el) return;
  el.addEventListener('input', recompute);
});

$('#copyBtn').addEventListener('click', async ()=>{
  const txt = $('#jsonOut').textContent;
  try{
    await navigator.clipboard.writeText(txt);
    $('#copyHint').textContent = 'Kopiert!';
    setTimeout(()=>$('#copyHint').textContent='', 1500);
  }catch{
    $('#copyHint').textContent = 'Klarte ikke kopiere – marker teksten og kopier manuelt.';
  }
});

/* ========= Init ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  buildWeekOptions();
});
</script>
</body>
</html>
